<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Echte Audio-Daten</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        pre { background: #2d2d2d; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .track { margin: 10px 0; padding: 10px; background: #333; border-radius: 4px; }
        audio { width: 100%; margin: 10px 0; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üéµ Debug: Echte Audio-Daten</h1>
    
    <div class="section">
        <h2>üìÅ Audio-Datei hochladen</h2>
        <input type="file" id="audioFile" accept="audio/*" />
        <button class="button" onclick="processAudioFile()">üîÑ Audio-Datei verarbeiten</button>
        <div id="fileResult"></div>
    </div>
    
    <div class="section">
        <h2>üß™ Test: Blob-URL zu Base64</h2>
        <button class="button" onclick="testBlobToBase64()">üîÑ Blob-zu-Base64 Test</button>
        <div id="blobResult"></div>
    </div>
    
    <div class="section">
        <h2>üéµ Test: Audio Playback</h2>
        <button class="button" onclick="testAudioPlayback()">‚ñ∂Ô∏è Audio Playback testen</button>
        <div id="playbackResult"></div>
    </div>
    
    <div class="section">
        <h2>üìä Aktuelle Pending Uploads</h2>
        <button class="button" onclick="showPendingUploads()">üîç Pending Uploads anzeigen</button>
        <div id="pendingResult"></div>
    </div>

    <script>
        let currentAudioFile = null;
        let currentBlobUrl = null;
        let currentBase64Url = null;

        function processAudioFile() {
            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('fileResult').innerHTML = '<div class="error">‚ùå Bitte w√§hlen Sie eine Audio-Datei aus</div>';
                return;
            }
            
            currentAudioFile = file;
            console.log('üìÅ Audio-Datei ausgew√§hlt:', {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
            });
            
            // Erstelle Blob-URL
            currentBlobUrl = URL.createObjectURL(file);
            console.log('üîó Blob-URL erstellt:', currentBlobUrl);
            
            document.getElementById('fileResult').innerHTML = `
                <div class="success">‚úÖ Audio-Datei verarbeitet</div>
                <p><strong>Name:</strong> ${file.name}</p>
                <p><strong>Gr√∂√üe:</strong> ${file.size} Bytes</p>
                <p><strong>Typ:</strong> ${file.type}</p>
                <p><strong>Blob-URL:</strong> ${currentBlobUrl}</p>
                <audio controls src="${currentBlobUrl}" style="width: 100%; margin: 10px 0;"></audio>
            `;
        }

        function testBlobToBase64() {
            if (!currentBlobUrl) {
                document.getElementById('blobResult').innerHTML = '<div class="error">‚ùå Bitte laden Sie zuerst eine Audio-Datei hoch</div>';
                return;
            }
            
            console.log('üîÑ Teste Blob-zu-Base64 Konvertierung...');
            
            fetch(currentBlobUrl)
                .then(response => {
                    console.log('üì° Fetch Response:', {
                        ok: response.ok,
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    console.log('üì¶ Blob erhalten:', {
                        size: blob.size,
                        type: blob.type,
                        isBlob: blob instanceof Blob
                    });
                    
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const result = reader.result;
                            console.log('‚úÖ Base64-URL erstellt:', {
                                length: result.length,
                                startsWithData: result.startsWith('data:'),
                                first100Chars: result.substring(0, 100)
                            });
                            resolve(result);
                        };
                        reader.onerror = (error) => {
                            console.error('‚ùå FileReader Fehler:', error);
                            reject(error);
                        };
                        reader.readAsDataURL(blob);
                    });
                })
                .then(base64Url => {
                    currentBase64Url = base64Url;
                    
                    document.getElementById('blobResult').innerHTML = `
                        <div class="success">‚úÖ Blob-zu-Base64 Konvertierung erfolgreich</div>
                        <p><strong>Blob-URL:</strong> ${currentBlobUrl}</p>
                        <p><strong>Base64-URL L√§nge:</strong> ${base64Url.length}</p>
                        <p><strong>Base64-URL startet mit data:</strong> ${base64Url.startsWith('data:') ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Base64-URL (erste 100 Zeichen):</strong> ${base64Url.substring(0, 100)}...</p>
                        <audio controls src="${base64Url}" style="width: 100%; margin: 10px 0;"></audio>
                    `;
                })
                .catch(error => {
                    console.error('‚ùå Fehler bei der Konvertierung:', error);
                    document.getElementById('blobResult').innerHTML = `
                        <div class="error">‚ùå Fehler bei der Konvertierung: ${error.message}</div>
                    `;
                });
        }

        function testAudioPlayback() {
            if (!currentBase64Url) {
                document.getElementById('playbackResult').innerHTML = '<div class="error">‚ùå Bitte f√ºhren Sie zuerst die Blob-zu-Base64 Konvertierung durch</div>';
                return;
            }
            
            console.log('üéµ Teste Audio Playback...');
            
            const audio = new Audio();
            audio.src = currentBase64Url;
            
            audio.addEventListener('loadstart', () => {
                console.log('üéµ Audio loadstart');
            });
            
            audio.addEventListener('loadedmetadata', () => {
                console.log('üéµ Audio loadedmetadata, Duration:', audio.duration);
            });
            
            audio.addEventListener('canplay', () => {
                console.log('üéµ Audio canplay');
            });
            
            audio.addEventListener('error', (e) => {
                console.error('üéµ Audio error:', e);
                document.getElementById('playbackResult').innerHTML = `
                    <div class="error">‚ùå Audio Playback Fehler: ${e.type}</div>
                    <p><strong>Error Code:</strong> ${audio.error?.code}</p>
                    <p><strong>Error Message:</strong> ${audio.error?.message}</p>
                    <p><strong>Audio Source:</strong> ${audio.src.substring(0, 100)}...</p>
                `;
            });
            
            audio.addEventListener('loadeddata', () => {
                console.log('üéµ Audio loadeddata - Playback sollte funktionieren');
                document.getElementById('playbackResult').innerHTML = `
                    <div class="success">‚úÖ Audio Playback Test erfolgreich</div>
                    <p><strong>Base64-URL L√§nge:</strong> ${currentBase64Url.length}</p>
                    <p><strong>Audio Duration:</strong> ${audio.duration || 'Unbekannt'}</p>
                    <audio controls src="${currentBase64Url}" style="width: 100%; margin: 10px 0;"></audio>
                `;
            });
            
            audio.load();
        }

        function showPendingUploads() {
            console.log('üìä Zeige Pending Uploads...');
            
            const pendingUploads = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
            const uploadIds = Object.keys(pendingUploads);
            
            console.log(`üìä Gefunden: ${uploadIds.length} Pending Uploads`);
            
            let html = `
                <div class="info">
                    <h3>üìä Pending Uploads: ${uploadIds.length}</h3>
                </div>
            `;
            
            if (uploadIds.length > 0) {
                uploadIds.forEach((uploadId, index) => {
                    const upload = pendingUploads[uploadId];
                    html += `
                        <div class="track">
                            <h4>Upload ${index + 1}: ${upload.title}</h4>
                            <p><strong>ID:</strong> ${upload.uploadId}</p>
                            <p><strong>Filename:</strong> ${upload.filename}</p>
                            <p><strong>Size:</strong> ${upload.size} Bytes</p>
                            <p><strong>Duration:</strong> ${upload.duration} Sekunden</p>
                            <p><strong>URL Type:</strong> ${upload.url ? (upload.url.startsWith('blob:') ? 'Blob' : 'Base64') : 'No URL'}</p>
                            <p><strong>URL:</strong> ${upload.url ? upload.url.substring(0, 100) + '...' : 'No URL'}</p>
                            ${upload.url ? `<audio controls src="${upload.url}" style="width: 100%; margin: 10px 0;"></audio>` : ''}
                        </div>
                    `;
                });
            } else {
                html += '<div class="warning">‚ö†Ô∏è Keine Pending Uploads gefunden</div>';
            }
            
            document.getElementById('pendingResult').innerHTML = html;
        }

        // Initialisierung
        console.log('üöÄ Echte Audio-Daten Debug System initialisiert');
    </script>
</body>
</html>
