(function(){"use strict";var a;(function(r){r.LOAD="LOAD",r.EXEC="EXEC",r.FFPROBE="FFPROBE",r.WRITE_FILE="WRITE_FILE",r.READ_FILE="READ_FILE",r.DELETE_FILE="DELETE_FILE",r.RENAME="RENAME",r.CREATE_DIR="CREATE_DIR",r.LIST_DIR="LIST_DIR",r.DELETE_DIR="DELETE_DIR",r.ERROR="ERROR",r.DOWNLOAD="DOWNLOAD",r.PROGRESS="PROGRESS",r.LOG="LOG",r.MOUNT="MOUNT",r.UNMOUNT="UNMOUNT"})(a||(a={}));const D=(()=>{let r=0;return()=>r++})(),O=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),p=new Error("called FFmpeg.terminate()");class L{#t=null;#s={};#r={};#a=[];#n=[];loaded=!1;#o=()=>{this.#t&&(this.#t.onmessage=({data:{id:e,type:t,data:s}})=>{switch(t){case a.LOAD:this.loaded=!0,this.#s[e](s);break;case a.MOUNT:case a.UNMOUNT:case a.EXEC:case a.FFPROBE:case a.WRITE_FILE:case a.READ_FILE:case a.DELETE_FILE:case a.RENAME:case a.CREATE_DIR:case a.LIST_DIR:case a.DELETE_DIR:this.#s[e](s);break;case a.LOG:this.#a.forEach(n=>n(s));break;case a.PROGRESS:this.#n.forEach(n=>n(s));break;case a.ERROR:this.#r[e](s);break}delete this.#s[e],delete this.#r[e]})};#e=({type:e,data:t},s=[],n)=>this.#t?new Promise((o,i)=>{const E=D();this.#t&&this.#t.postMessage({id:E,type:e,data:t},s),this.#s[E]=o,this.#r[E]=i,n?.addEventListener("abort",()=>{i(new DOMException(`Message # ${E} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(O);on(e,t){e==="log"?this.#a.push(t):e==="progress"&&this.#n.push(t)}off(e,t){e==="log"?this.#a=this.#a.filter(s=>s!==t):e==="progress"&&(this.#n=this.#n.filter(s=>s!==t))}load=({classWorkerURL:e,...t}={},{signal:s}={})=>(this.#t||(this.#t=e?new Worker(new URL(e,self.location.href),{type:"module"}):new Worker(new URL("/assets/worker-BAOIWoxA.js",self.location.href),{type:"module"}),this.#o()),this.#e({type:a.LOAD,data:t},void 0,s));exec=(e,t=-1,{signal:s}={})=>this.#e({type:a.EXEC,data:{args:e,timeout:t}},void 0,s);ffprobe=(e,t=-1,{signal:s}={})=>this.#e({type:a.FFPROBE,data:{args:e,timeout:t}},void 0,s);terminate=()=>{const e=Object.keys(this.#r);for(const t of e)this.#r[t](p),delete this.#r[t],delete this.#s[t];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(e,t,{signal:s}={})=>{const n=[];return t instanceof Uint8Array&&n.push(t.buffer),this.#e({type:a.WRITE_FILE,data:{path:e,data:t}},n,s)};mount=(e,t,s)=>{const n=[];return this.#e({type:a.MOUNT,data:{fsType:e,options:t,mountPoint:s}},n)};unmount=e=>{const t=[];return this.#e({type:a.UNMOUNT,data:{mountPoint:e}},t)};readFile=(e,t="binary",{signal:s}={})=>this.#e({type:a.READ_FILE,data:{path:e,encoding:t}},void 0,s);deleteFile=(e,{signal:t}={})=>this.#e({type:a.DELETE_FILE,data:{path:e}},void 0,t);rename=(e,t,{signal:s}={})=>this.#e({type:a.RENAME,data:{oldPath:e,newPath:t}},void 0,s);createDir=(e,{signal:t}={})=>this.#e({type:a.CREATE_DIR,data:{path:e}},void 0,t);listDir=(e,{signal:t}={})=>this.#e({type:a.LIST_DIR,data:{path:e}},void 0,t);deleteDir=(e,{signal:t}={})=>this.#e({type:a.DELETE_DIR,data:{path:e}},void 0,t)}var R;(function(r){r.MEMFS="MEMFS",r.NODEFS="NODEFS",r.NODERAWFS="NODERAWFS",r.IDBFS="IDBFS",r.WORKERFS="WORKERFS",r.PROXYFS="PROXYFS"})(R||(R={}));const I=new Error("failed to get response body reader"),m=new Error("failed to complete download"),A="Content-Length",_=async(r,e)=>{const t=await fetch(r);let s;try{const n=parseInt(t.headers.get(A)||"-1"),o=t.body?.getReader();if(!o)throw I;const i=[];let E=0;for(;;){const{done:f,value:d}=await o.read(),l=d?d.length:0;if(f){if(n!=-1&&n!==E)throw m;e&&e({url:r,total:n,received:E,delta:l,done:f});break}i.push(d),E+=l,e&&e({url:r,total:n,received:E,delta:l,done:f})}const u=new Uint8Array(E);let w=0;for(const f of i)u.set(f,w),w+=f.length;s=u.buffer}catch(n){console.log("failed to send download progress event: ",n),s=await t.arrayBuffer()}return s},h=async(r,e,t=!1,s)=>{const n=t?await _(r,s):await(await fetch(r)).arrayBuffer(),o=new Blob([n],{type:e});return URL.createObjectURL(o)};let c=null;async function g(){if(c)return c;c=new L;const r="https://unpkg.com/@ffmpeg/core@0.12.4/dist";try{await c.load({coreURL:await h(`${r}/ffmpeg-core.js`,"text/javascript"),wasmURL:await h(`${r}/ffmpeg-core.wasm`,"application/wasm")}),console.log("FFmpeg loaded successfully")}catch(e){throw console.error("Failed to load FFmpeg:",e),new Error("FFmpeg konnte nicht geladen werden. Verwende WAV-Export.")}return c}self.onmessage=async r=>{const{type:e,wavArrayBuffer:t,fmt:s,kbps:n}=r.data||{};if(e==="encode")try{const o=await g();if(await o.writeFile("in.wav",new Uint8Array(t)),s==="mp3"){await o.exec(["-i","in.wav","-b:a",`${n}k`,"out.mp3"]);const i=await o.readFile("out.mp3");self.postMessage({type:"done",data:i.buffer},[i.buffer]);return}if(s==="aac"){await o.exec(["-i","in.wav","-c:a","aac","-b:a",`${n}k`,"out.aac"]);const i=await o.readFile("out.aac");self.postMessage({type:"done",data:i.buffer},[i.buffer]);return}self.postMessage({type:"error",error:"Unsupported format"})}catch(o){self.postMessage({type:"error",error:String(o)})}}})();
