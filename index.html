
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickUp Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .welcome-header {
            margin-bottom: 20px;
            color: #ffffff;
            background: #1a1a1a;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .welcome-text {
            font-size: 1.4rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .welcome-name-line {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .top-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .folder-select-btn, .refresh-btn, .logout-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-select-btn {
            background: #fbbf24;
            color: #000;
        }

        .folder-select-btn:hover {
            background: #f59e0b;
        }

        .refresh-btn {
            background: #374151;
            color: #fff;
        }

        .refresh-btn:hover {
            background: #4b5563;
        }

        .logout-btn {
            background: #dc2626;
            color: #fff;
        }

        .logout-btn:hover {
            background: #ef4444;
        }

        .api-section {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-section.hidden {
            display: none;
        }

        .api-section h2 {
            margin-bottom: 20px;
            color: #1e293b;
            font-weight: 600;
        }

        .api-input-group {
            display: flex;
            gap: 12px;
            max-width: 500px;
            margin: 0 auto;
        }

        .api-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background: #f8fafc;
            color: #1e293b;
        }

        .api-input:focus {
            outline: none;
            border-color: #cbd5e1;
            background: white;
        }

        .load-btn {
            padding: 12px 24px;
            background: #1e293b;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .load-btn:hover:not(:disabled) {
            background: #334155;
        }

        .load-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .filter-section {
            background: #1a1a1a;
            border-radius: 20px;
            margin-bottom: 15px;
            overflow: hidden;
            display: none;
        }

        .filter-section.show {
            display: block;
        }

        .filter-content {
            padding: 20px;
        }

        .filter-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: #2a2a2a;
            border-radius: 12px;
            position: relative;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #fbbf24;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 0.85rem;
            color: #ffffff;
            font-weight: 500;
            flex: 1;
        }

        .folder-menu {
            position: relative;
        }

        .folder-menu-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .folder-menu-btn:hover {
            background: #374151;
            color: #ffffff;
        }

        .folder-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2a2a2a;
            border-radius: 12px;
            padding: 12px;
            min-width: 200px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .folder-dropdown.show {
            display: block;
        }

        .folder-dropdown input {
            width: 100%;
            padding: 6px 8px;
            margin: 4px 0;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 8px;
            color: #ffffff;
            font-size: 12px;
        }

        .folder-dropdown label {
            font-size: 0.75rem;
            color: #94a3b8;
            display: block;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .folder-icons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .folder-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            text-decoration: none;
            font-weight: 700;
            color: #000;
        }

        .folder-icon.miro {
            background: #fbbf24;
        }

        .folder-icon.brand {
            background: #dc2626;
            color: #fff;
        }

        .folder-icon.custom {
            background: #6b7280;
            color: #fff;
        }

        .folder-icon:hover {
            transform: scale(1.1);
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .column {
            background: #ffffff;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .column.mixed {
            background: #e8f5e8;
        }

        .column.mixed .column-header {
            background: #d4edda;
        }

        .column.mixed .column-content {
            background: #e8f5e8;
        }

        .column-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            color: #1e293b;
            background: #f8fafc;
            font-size: 0.85rem;
        }

        .column-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-title {
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .column-icons {
            display: flex;
            gap: 4px;
        }

        .column-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 9px;
            text-decoration: none;
            font-weight: 700;
        }

        .column-icon.miro {
            background: #fbbf24;
            color: #000;
        }

        .column-icon.brand {
            background: #dc2626;
            color: #fff;
        }

        .column-icon.custom {
            background: #6b7280;
            color: #fff;
        }

        .column-count {
            background: rgba(0,0,0,0.08);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .toggle-triangle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid #666666;
            transition: transform 0.3s ease;
        }

        .toggle-triangle.collapsed {
            transform: rotate(-90deg);
        }

        .special-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            background: #f8fafc;
            color: #1e293b;
            font-size: 0.85rem;
        }

        .overdue-header .special-title {
            color: #dc2626;
            font-weight: 600;
        }

        .unplanned-header .special-title {
            color: #0369a1;
            font-weight: 600;
        }

        .special-count {
            background: rgba(0,0,0,0.08);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .column-content {
            padding: 0;
            max-height: none;
            overflow: visible;
            background: #ffffff;
            transition: all 0.3s ease;
        }

        .column-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .column.mixed .column-content {
            background: #e8f5e8;
        }

        .task-item {
            background: #808080;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 12px;
            transition: background-color 0.2s;
            font-size: 0.8rem;
        }

        .task-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.8rem;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .task-path {
            font-size: 0.65rem;
            color: #999999;
            margin-bottom: 4px;
            font-weight: 400;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            gap: 8px;
        }

        .task-due {
            color: #666666;
            font-weight: 500;
            font-size: 0.7rem;
        }

        .task-status {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .special-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .special-section {
            background: #ffffff;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .special-content {
            padding: 0;
            max-height: none;
            overflow: visible;
            background: #ffffff;
            transition: all 0.3s ease;
        }

        .special-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .folder-section {
            margin: 0;
            padding: 8px 12px;
            background: transparent;
            border-radius: 0;
        }

        .folder-section:not(:last-child) {
            border-bottom: 1px solid #f1f5f9;
        }

        .folder-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: #666666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading, .error, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .spinner {
            border: 3px solid #374151;
            border-top: 3px solid #fbbf24;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auto-refresh-indicator {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        @media (max-width: 1200px) {
            .tasks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .tasks-grid {
                grid-template-columns: 1fr;
            }
            
            .special-sections {
                grid-template-columns: 1fr;
            }

            .filter-checkboxes {
                grid-template-columns: 1fr;
            }

            .welcome-header {
                text-align: center;
            }

            .top-controls {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls" id="topControls" style="display: none;">
            <button class="folder-select-btn" id="folderSelectBtn">📁 Ordner wählen</button>
            <div class="auto-refresh-indicator" id="refreshTimer">10:00</div>
            <button class="refresh-btn" id="refreshBtn">🔄</button>
            <button class="logout-btn" id="logoutBtn">Abmelden</button>
        </div>

        <div class="welcome-header" id="welcomeHeader" style="display: none;">
            <div class="welcome-text">Hallo</div>
            <div class="welcome-name-line">
                <img id="profilePic" class="profile-pic" src="" alt="Profil">
                <span id="welcomeName">Benutzer</span> 👋
            </div>
            <div class="welcome-text">Willkommen zurück. Hier sind deine Aufgaben.</div>
        </div>

        <div class="api-section" id="apiSection">
            <h2>ClickUp Dashboard</h2>
            <p style="color: #64748b; margin-bottom: 20px;">Geben Sie Ihren ClickUp API Token ein:</p>
            <div class="api-input-group">
                <input 
                    type="password" 
                    class="api-input" 
                    id="apiKey" 
                    placeholder="ClickUp API Token..."
                    autocomplete="off"
                >
                <button class="load-btn" id="loadTasks">Dashboard laden</button>
            </div>
        </div>

        <div class="filter-section" id="filterSection">
            <div class="filter-content" id="filter-content">
                <div class="filter-checkboxes" id="filterCheckboxes">
                    <!-- Checkboxes werden hier eingefügt -->
                </div>
            </div>
        </div>

        <div class="content" id="content">
            <div class="empty-state">
                <p>API Token eingeben und Dashboard laden...</p>
            </div>
        </div>
    </div>

    <script>
        let apiToken = '';
        let allTasks = [];
        let availableFolders = [];
        let selectedFolders = new Set();
        let userProfile = null;
        let folderSettings = {};
        let refreshTimer = null;
        let refreshCountdown = 600;

        document.getElementById('loadTasks').addEventListener('click', loadTasks);
        document.getElementById('refreshBtn').addEventListener('click', refreshData);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('folderSelectBtn').addEventListener('click', toggleFolderSelection);
        document.getElementById('apiKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadTasks();
            }
        });

        function toggleFolderSelection() {
            const filterSection = document.getElementById('filterSection');
            filterSection.classList.toggle('show');
        }

        function startRefreshTimer() {
            if (refreshTimer) clearInterval(refreshTimer);
            
            refreshTimer = setInterval(() => {
                refreshCountdown--;
                updateRefreshDisplay();
                
                if (refreshCountdown <= 0) {
                    refreshData();
                    refreshCountdown = 600;
                }
            }, 1000);
        }

        function updateRefreshDisplay() {
            const minutes = Math.floor(refreshCountdown / 60);
            const seconds = refreshCountdown % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const indicator = document.getElementById('refreshTimer');
            if (indicator) {
                indicator.textContent = display;
            }
        }

        async function refreshData() {
            if (!apiToken) return;
            
            console.log('Automatische Aktualisierung im Hintergrund...');
            refreshCountdown = 600;
            
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.textContent = '⏳';
            refreshBtn.disabled = true;
            
            try {
                // Refresh im Hintergrund - UI nicht blockieren
                await loadTasksInternal(true);
            } catch (error) {
                console.error('Refresh-Fehler:', error);
            }
            
            refreshBtn.textContent = '🔄';
            refreshBtn.disabled = false;
        }

        function logout() {
            apiToken = '';
            allTasks = [];
            availableFolders = [];
            selectedFolders.clear();
            userProfile = null;
            folderSettings = {};
            
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            document.getElementById('apiSection').classList.remove('hidden');
            document.getElementById('topControls').style.display = 'none';
            document.getElementById('welcomeHeader').style.display = 'none';
            document.getElementById('filterSection').classList.remove('show');
            document.getElementById('apiKey').value = '';
            document.getElementById('content').innerHTML = '<div class="empty-state"><p>API Token eingeben und Dashboard laden...</p></div>';
        }

        async function loadTasks() {
            const apiKeyInput = document.getElementById('apiKey');
            const loadBtn = document.getElementById('loadTasks');

            apiToken = apiKeyInput.value.trim();
            
            if (!apiToken) {
                showError('Bitte API Token eingeben.');
                return;
            }

            if (!apiToken.startsWith('pk_')) {
                showError('Ungültiger Token (muss mit "pk_" beginnen)');
                return;
            }

            loadBtn.disabled = true;
            loadBtn.textContent = 'Lädt...';
            
            try {
                await loadTasksInternal(false);
                
                document.getElementById('apiSection').classList.add('hidden');
                document.getElementById('topControls').style.display = 'flex';
                document.getElementById('welcomeHeader').style.display = 'flex';
                
                startRefreshTimer();
                
            } catch (error) {
                console.error('Load-Fehler:', error);
                showError(`Fehler: ${error.message}`);
            }

            loadBtn.disabled = false;
            loadBtn.textContent = 'Dashboard laden';
        }

        async function loadTasksInternal(isBackgroundRefresh = false) {
            const content = document.getElementById('content');
            
            if (!isBackgroundRefresh) {
                content.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Lade Aufgaben und Profil...</p>
                    </div>
                `;
            }

            try {
                const userResponse = await fetch('https://api.clickup.com/api/v2/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': apiToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    userProfile = userData.user;
                    
                    // Update nur bei erstem Load, nicht bei Background-Refresh
                    if (!isBackgroundRefresh) {
                        const profilePic = document.getElementById('profilePic');
                        const welcomeName = document.getElementById('welcomeName');
                        
                        if (userProfile.profilePicture) {
                            profilePic.src = userProfile.profilePicture;
                        } else {
                            profilePic.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.username)}&background=fbbf24&color=000000`;
                        }
                        
                        // Nur Vorname extrahieren
                        const firstName = userProfile.username.split(' ')[0];
                        welcomeName.textContent = firstName;
                    }
                }

                const teamsResponse = await fetch('https://api.clickup.com/api/v2/team', {
                    method: 'GET',
                    headers: {
                        'Authorization': apiToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!teamsResponse.ok) {
                    throw new Error(`API-Fehler: ${teamsResponse.status}`);
                }

                const teamsData = await teamsResponse.json();
                const teams = teamsData.teams;
                
                allTasks = [];
                availableFolders = [];
                const targetSpaces = ['SZ_schiebezimmer', 'EMA', 'Projektkunden', 'PROJEKTKUNDEN'];

                for (const team of teams) {
                    const spacesResponse = await fetch(`https://api.clickup.com/api/v2/team/${team.id}/space`, {
                        method: 'GET',
                        headers: {
                            'Authorization': apiToken,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (spacesResponse.ok) {
                        const spacesData = await spacesResponse.json();
                        
                        for (const space of spacesData.spaces) {
                            if (targetSpaces.includes(space.name)) {
                                console.log(`Verarbeite Space: ${space.name}`);
                                await processSpace(space);
                            }
                        }
                    }
                }

                // Entferne Ordner mit null Aufgaben
                const folderTaskCounts = {};
                allTasks.forEach(task => {
                    const key = task.folderKey;
                    folderTaskCounts[key] = (folderTaskCounts[key] || 0) + 1;
                });

                // Filtere Ordner die Aufgaben haben
                availableFolders = availableFolders.filter(folder => {
                    return folderTaskCounts[folder.key] > 0;
                });

                availableFolders.sort((a, b) => {
                    return (folderTaskCounts[b.key] || 0) - (folderTaskCounts[a.key] || 0);
                });

                if (selectedFolders.size === 0) {
                    availableFolders.slice(0, 3).forEach(folder => {
                        selectedFolders.add(folder.key);
                    });
                }

                console.log(`${allTasks.length} Aufgaben geladen, ${availableFolders.length} Ordner mit Aufgaben`);
                
                displayApp();

            } catch (error) {
                throw error;
            }
        }

        async function processSpace(space) {
            try {
                const foldersResponse = await fetch(`https://api.clickup.com/api/v2/space/${space.id}/folder`, {
                    method: 'GET',
                    headers: {
                        'Authorization': apiToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (foldersResponse.ok) {
                    const foldersData = await foldersResponse.json();
                    
                    for (const folder of foldersData.folders) {
                        const folderKey = `${space.name}/${folder.name}`;
                        availableFolders.push({
                            key: folderKey,
                            spaceName: space.name,
                            folderName: folder.name,
                            folderId: folder.id
                        });

                        await processFolder(folder, space, folderKey);
                    }
                }

                const directListsResponse = await fetch(`https://api.clickup.com/api/v2/space/${space.id}/list`, {
                    method: 'GET',
                    headers: {
                        'Authorization': apiToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (directListsResponse.ok) {
                    const directListsData = await directListsResponse.json();
                    
                    if (directListsData.lists && directListsData.lists.length > 0) {
                        const folderKey = `${space.name}/Direkte Listen`;
                        availableFolders.push({
                            key: folderKey,
                            spaceName: space.name,
                            folderName: 'Direkte Listen',
                            folderId: null
                        });

                        for (const list of directListsData.lists) {
                            await processList(list, space, folderKey, `${space.name}/${list.name}`);
                        }
                    }
                }
            } catch (error) {
                console.warn(`Fehler bei Space ${space.name}:`, error);
            }
        }

        async function processFolder(folder, space, folderKey) {
            try {
                const listsResponse = await fetch(`https://api.clickup.com/api/v2/folder/${folder.id}/list`, {
                    method: 'GET',
                    headers: {
                        'Authorization': apiToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (listsResponse.ok) {
                    const listsData = await listsResponse.json();
                    
                    for (const list of listsData.lists) {
                        await processList(list, space, folderKey, `${space.name}/${folder.name}/${list.name}`);
                    }
                }
            } catch (error) {
                console.warn(`Fehler bei Folder ${folder.name}:`, error);
            }
        }

        async function processList(list, space, folderKey, folderPath) {
            try {
                const listTasksResponse = await fetch(`https://api.clickup.com/api/v2/list/${list.id}/task?include_closed=false&subtasks=true`, {
                    method: 'GET',
                    headers: {
                        'Authorization': apiToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (listTasksResponse.ok) {
                    const listTasksData = await listTasksResponse.json();
                    const allListTasks = listTasksData.tasks;
                    
                    allListTasks.forEach(task => {
                        if (isMyTask(task) && !isCompleted(task)) {
                            let taskPath = folderPath;
                            if (task.parent) {
                                const parentHierarchy = getFullParentHierarchy(task, allListTasks);
                                if (parentHierarchy.length > 0) {
                                    taskPath = `${folderPath} → ${task.name} (${parentHierarchy.join(' → ')})`;
                                }
                            }
                            
                            task.folderPath = taskPath;
                            task.folderKey = folderKey;
                            allTasks.push(task);
                        }
                    });
                }
            } catch (error) {
                console.warn(`Fehler bei Liste ${list.name}:`, error);
            }
        }

        function getFullParentHierarchy(task, allTasks) {
            const hierarchy = [];
            let currentTask = task;
            
            while (currentTask && currentTask.parent) {
                const parentTask = allTasks.find(t => t.id === currentTask.parent);
                if (parentTask) {
                    hierarchy.unshift(parentTask.name);
                    currentTask = parentTask;
                } else {
                    break;
                }
            }
            
            return hierarchy;
        }

        function isMyTask(task) {
            if (!task.assignees || task.assignees.length === 0) return false;
            
            if (userProfile) {
                return task.assignees.some(assignee => assignee.id === userProfile.id);
            }
            
            return task.assignees.some(assignee => {
                const username = (assignee.username || '').toLowerCase();
                const email = (assignee.email || '').toLowerCase();
                const fullName = (assignee.full_name || assignee.name || '').toLowerCase();
                
                const searchTerms = ['yevgeniy', 'yagolnik', 'yev'];
                
                return searchTerms.some(term => 
                    username.includes(term) || 
                    email.includes(term) || 
                    fullName.includes(term)
                );
            });
        }

        function isCompleted(task) {
            return task.status && (
                task.status.status === 'complete' || 
                task.status.status === 'closed' ||
                task.status.status.toLowerCase().includes('fertig') ||
                task.status.status.toLowerCase().includes('done')
            );
        }

        function displayApp() {
            const content = document.getElementById('content');
            
            const overdueTasks = allTasks.filter(task => {
                return task.due_date && parseInt(task.due_date) < Date.now();
            });
            const unplannedTasks = allTasks.filter(task => !task.due_date);

            let html = `
                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection()">
                        <div class="filter-title">📁 Ordner auswählen</div>
                    </div>
                    <div class="filter-content" id="filter-content">
                        <div class="filter-checkboxes">
            `;

            availableFolders.forEach(folder => {
                const taskCount = allTasks.filter(task => task.folderKey === folder.key).length;
                const isChecked = selectedFolders.has(folder.key) ? 'checked' : '';
                const folderId = folder.key.replace(/[^a-zA-Z0-9]/g, '_');
                
                html += `
                    <div class="checkbox-group">
                        <input type="checkbox" id="folder-${folderId}" 
                               ${isChecked} onchange="toggleFolder('${folder.key}')" />
                        <label for="folder-${folderId}">
                            ${folder.folderName} (${taskCount})
                        </label>
                        <div class="folder-menu">
                            <button class="folder-menu-btn" onclick="toggleFolderMenu('${folderId}')">⋯</button>
                            <div class="folder-dropdown" id="menu-${folderId}">
                                <label>Miro Board</label>
                                <input type="url" placeholder="https://miro.com/..." 
                                       value="${folderSettings[folder.key]?.miro || ''}" 
                                       onchange="updateFolderSetting('${folder.key}', 'miro', this.value)">
                                
                                <label>Markenhandbuch</label>
                                <input type="url" placeholder="https://..." 
                                       value="${folderSettings[folder.key]?.brand || ''}" 
                                       onchange="updateFolderSetting('${folder.key}', 'brand', this.value)">
                                
                                <label>Custom Link 1</label>
                                <input type="url" placeholder="https://..." 
                                       value="${folderSettings[folder.key]?.custom1 || ''}" 
                                       onchange="updateFolderSetting('${folder.key}', 'custom1', this.value)">
                                
                                <label>Custom Link 2</label>
                                <input type="url" placeholder="https://..." 
                                       value="${folderSettings[folder.key]?.custom2 || ''}" 
                                       onchange="updateFolderSetting('${folder.key}', 'custom2', this.value)">
                                
                                <div class="folder-icons">
                                    ${folderSettings[folder.key]?.miro ? `<a href="${folderSettings[folder.key].miro}" target="_blank" class="folder-icon">M</a>` : ''}
                                    ${folderSettings[folder.key]?.brand ? `<a href="${folderSettings[folder.key].brand}" target="_blank" class="folder-icon">B</a>` : ''}
                                    ${folderSettings[folder.key]?.custom1 ? `<a href="${folderSettings[folder.key].custom1}" target="_blank" class="folder-icon">1</a>` : ''}
                                    ${folderSettings[folder.key]?.custom2 ? `<a href="${folderSettings[folder.key].custom2}" target="_blank" class="folder-icon">2</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>

                <div class="tasks-grid" id="tasksGrid"></div>

                <div class="special-sections">
                    <div class="special-section">
                        <div class="special-header overdue-header" onclick="toggleSpecialSection('overdue')">
                            <div class="special-title">🚨 Überfällig (${overdueTasks.length})</div>
                        </div>
                        <div class="special-content" id="overdue-content">
            `;

            const overdueByFolder = groupTasksByFolder(overdueTasks);
            Object.entries(overdueByFolder).forEach(([folderName, tasks]) => {
                html += `
                    <div class="folder-section">
                        <div class="folder-section-title">${folderName}</div>
                `;
                tasks.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += `</div>`;
            });

            html += `
                        </div>
                    </div>

                    <div class="special-section">
                        <div class="special-header unplanned-header" onclick="toggleSpecialSection('unplanned')">
                            <div class="special-title">📋 Ungeplant (${unplannedTasks.length})</div>
                        </div>
                        <div class="special-content" id="unplanned-content">
            `;

            const unplannedByFolder = groupTasksByFolder(unplannedTasks);
            Object.entries(unplannedByFolder).forEach(([folderName, tasks]) => {
                html += `
                    <div class="folder-section">
                        <div class="folder-section-title">${folderName}</div>
                `;
                tasks.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += `</div>`;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            updateTasksDisplay();
        }

        function updateFolderSetting(folderKey, setting, value) {
            if (!folderSettings[folderKey]) {
                folderSettings[folderKey] = {};
            }
            folderSettings[folderKey][setting] = value;
            
            const folderId = folderKey.replace(/[^a-zA-Z0-9]/g, '_');
            const iconsContainer = document.querySelector(`#menu-${folderId} .folder-icons`);
            if (iconsContainer) {
                iconsContainer.innerHTML = `
                    ${folderSettings[folderKey]?.miro ? `<a href="${folderSettings[folderKey].miro}" target="_blank" class="folder-icon">M</a>` : ''}
                    ${folderSettings[folderKey]?.brand ? `<a href="${folderSettings[folderKey].brand}" target="_blank" class="folder-icon">B</a>` : ''}
                    ${folderSettings[folderKey]?.custom1 ? `<a href="${folderSettings[folderKey].custom1}" target="_blank" class="folder-icon">1</a>` : ''}
                    ${folderSettings[folderKey]?.custom2 ? `<a href="${folderSettings[folderKey].custom2}" target="_blank" class="folder-icon">2</a>` : ''}
                `;
            }
            
            // Update auch in der Tasks-Grid
            updateTasksDisplay();
        }

        function toggleFolderMenu(folderId) {
            const menu = document.getElementById(`menu-${folderId}`);
            const allMenus = document.querySelectorAll('.folder-dropdown');
            
            allMenus.forEach(m => {
                if (m.id !== `menu-${folderId}`) {
                    m.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }

        function groupTasksByFolder(tasks) {
            const grouped = {};
            tasks.forEach(task => {
                const folderName = availableFolders.find(f => f.key === task.folderKey)?.folderName || 'Unbekannt';
                if (!grouped[folderName]) {
                    grouped[folderName] = [];
                }
                grouped[folderName].push(task);
            });
            return grouped;
        }

        function toggleFolder(folderKey) {
            if (selectedFolders.has(folderKey)) {
                selectedFolders.delete(folderKey);
            } else {
                selectedFolders.add(folderKey);
            }
            updateTasksDisplay();
        }

        function updateTasksDisplay() {
            const tasksGrid = document.getElementById('tasksGrid');
            
            if (selectedFolders.size === 0) {
                tasksGrid.innerHTML = '<div class="empty-state"><p>Keine Ordner ausgewählt</p></div>';
                return;
            }

            let html = '';
            const selectedArray = Array.from(selectedFolders);

            selectedArray.forEach(folderKey => {
                const folder = availableFolders.find(f => f.key === folderKey);
                const folderTasks = allTasks
                    .filter(task => task.folderKey === folderKey)
                    .sort((a, b) => {
                        const aDate = a.due_date ? parseInt(a.due_date) : Infinity;
                        const bDate = b.due_date ? parseInt(b.due_date) : Infinity;
                        const now = Date.now();
                        
                        const aOverdue = aDate < now;
                        const bOverdue = bDate < now;
                        
                        if (aOverdue && !bOverdue) return -1;
                        if (!aOverdue && bOverdue) return 1;
                        
                        return aDate - bDate;
                    });

                const folderIcons = generateFolderIcons(folderKey);

                html += `
                    <div class="column">
                        <div class="column-header" onclick="toggleColumn('${folderKey.replace(/[^a-zA-Z0-9]/g, '_')}')">
                            <div class="column-header-left">
                                <div class="column-title" title="${folder.folderName}">${folder.folderName}</div>
                                <div class="column-icons">${folderIcons}</div>
                            </div>
                            <div>
                                <span class="column-count">${folderTasks.length}</span>
                            </div>
                        </div>
                        <div class="column-content" id="content-${folderKey.replace(/[^a-zA-Z0-9]/g, '_')}">
                `;

                folderTasks.forEach(task => {
                    html += renderTaskItem(task);
                });

                html += `</div></div>`;
            });

            const unselectedFolders = availableFolders.filter(f => !selectedFolders.has(f.key));
            const folderTaskCounts = {};
            unselectedFolders.forEach(folder => {
                folderTaskCounts[folder.key] = allTasks.filter(task => task.folderKey === folder.key).length;
            });

            unselectedFolders.sort((a, b) => (folderTaskCounts[b.key] || 0) - (folderTaskCounts[a.key] || 0));

            const mixedTasks = [];
            unselectedFolders.forEach(folder => {
                const tasks = allTasks.filter(task => task.folderKey === folder.key);
                mixedTasks.push(...tasks);
            });

            if (mixedTasks.length > 0) {
                html += `
                    <div class="column mixed">
                        <div class="column-header" onclick="toggleColumn('mixed')">
                            <div class="column-header-left">
                                <div class="column-title">Andere Ordner</div>
                            </div>
                            <div>
                                <span class="column-count">${mixedTasks.length}</span>
                            </div>
                        </div>
                        <div class="column-content" id="content-mixed">
                `;

                const mixedByFolder = {};
                mixedTasks.forEach(task => {
                    const folderName = availableFolders.find(f => f.key === task.folderKey)?.folderName || 'Unbekannt';
                    if (!mixedByFolder[folderName]) {
                        mixedByFolder[folderName] = [];
                    }
                    mixedByFolder[folderName].push(task);
                });

                Object.entries(mixedByFolder).forEach(([folderName, tasks]) => {
                    html += `
                        <div class="folder-section">
                            <div class="folder-section-title">${folderName}</div>
                    `;
                    tasks.forEach(task => {
                        html += renderTaskItem(task);
                    });
                    html += `</div>`;
                });

                html += `</div></div>`;
            }

            tasksGrid.innerHTML = html;
        }

        function generateFolderIcons(folderKey) {
            const settings = folderSettings[folderKey];
            if (!settings) return '';
            
            let icons = '';
            if (settings.miro) {
                icons += `<a href="${settings.miro}" target="_blank" class="column-icon" title="Miro Board">M</a>`;
            }
            if (settings.brand) {
                icons += `<a href="${settings.brand}" target="_blank" class="column-icon" title="Markenhandbuch">B</a>`;
            }
            if (settings.custom1) {
                icons += `<a href="${settings.custom1}" target="_blank" class="column-icon" title="Custom Link 1">1</a>`;
            }
            if (settings.custom2) {
                icons += `<a href="${settings.custom2}" target="_blank" class="column-icon" title="Custom Link 2">2</a>`;
            }
            
            return icons;
        }

        function renderTaskItem(task) {
            const taskUrl = task.url || `https://app.clickup.com/t/${task.id}`;
            const dueDate = task.due_date ? new Date(parseInt(task.due_date)) : null;
            let dueDateClass = '';
            let dueDateText = 'Ungeplant';

            if (dueDate) {
                const now = new Date();
                const diffTime = dueDate.getTime() - now.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                dueDateText = dueDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                if (diffDays < 0) {
                    dueDateClass = 'overdue';
                    dueDateText += ` (${Math.abs(diffDays)}d überfällig)`;
                } else if (diffDays === 0) {
                    dueDateClass = 'today';
                    dueDateText += ' (Heute)';
                } else if (diffDays === 1) {
                    dueDateClass = 'today';
                    dueDateText += ' (Morgen)';
                }
            }

            const statusClass = getStatusClass(task.status?.status);
            const statusText = task.status?.status || 'offen';

            return `
                <div class="task-item">
                    <div class="task-name">
                        <a href="${taskUrl}" target="_blank" rel="noopener">
                            ${task.name}
                        </a>
                    </div>
                    <div class="task-path">${task.folderPath}</div>
                    <div class="task-meta">
                        <div class="task-due ${dueDateClass}">${dueDateText}</div>
                        <span class="task-status ${statusClass}">${statusText}</span>
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            if (!status) return 'status-default';
            const statusLower = status.toLowerCase();
            
            if (statusLower.includes('progress') || statusLower.includes('bearbeitung')) return 'status-in-progress';
            if (statusLower.includes('review') || statusLower.includes('prüfung')) return 'status-review';
            if (statusLower.includes('open') || statusLower.includes('to do')) return 'status-open';
            
            return 'status-default';
        }

        function toggleColumn(columnId) {
            const content = document.getElementById(`content-${columnId}`);
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        function toggleFilterSection() {
            const content = document.getElementById('filter-content');
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        function toggleSpecialSection(section) {
            const content = document.getElementById(`${section}-content`);
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        function toggleFolderMenu(folderId) {
            const menu = document.getElementById(`menu-${folderId}`);
            const allMenus = document.querySelectorAll('.folder-dropdown');
            
            allMenus.forEach(m => {
                if (m.id !== `menu-${folderId}`) {
                    m.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }

        function groupTasksByFolder(tasks) {
            const grouped = {};
            tasks.forEach(task => {
                const folderName = availableFolders.find(f => f.key === task.folderKey)?.folderName || 'Unbekannt';
                if (!grouped[folderName]) {
                    grouped[folderName] = [];
                }
                grouped[folderName].push(task);
            });
            return grouped;
        }

        function toggleFolder(folderKey) {
            if (selectedFolders.has(folderKey)) {
                selectedFolders.delete(folderKey);
            } else {
                selectedFolders.add(folderKey);
            }
            updateTasksDisplay();
        }

        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `<div class="error" style="background: #dc2626; color: #ffffff; padding: 30px; border-radius: 20px; text-align: center;"><h3>Fehler</h3><p>${message}</p></div>`;
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.folder-menu')) {
                document.querySelectorAll('.folder-dropdown').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>
