import { useEffect, useState, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { Play, Pause, Heart, MessageCircle, Bookmark, Share, Send, Flag, User, Calendar } from 'lucide-react';
import { usePlayerStore } from '../stores/playerStore';
import { useUserStore } from '../stores/userStore';
import { useDatabase } from '../hooks/useDatabase';
import { useAudioPlayer } from '../hooks/useAudioPlayer';
import { getGlobalAudio, getGlobalAudioAnalyser } from '../hooks/useGlobalAudioManager';
import { formatDuration } from '../utils';
import { EnhancedAudioVisualizer } from '../components/audio/EnhancedAudioVisualizer';
import { UnicornBeamAudioVisualizer } from '../components/audio/UnicornBeamAudioVisualizer';
import { DynamicPlayIcon } from '../components/ui/DynamicPlayIcon';

export const PlayerPage = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { currentUser } = useUserStore();
  const { currentTrack, isPlaying, currentTime, duration, expand, collapse, setCurrentTrack } = usePlayerStore();
  const { tracks, toggleLike, toggleBookmark, addCommentToTrack, addReport, toggleCommentLike, isCommentLikedByUser, getCommentLikeCount, comments } = useDatabase(currentUser?.id);
  const { toggle, seek } = useAudioPlayer();
  
  const [commentText, setCommentText] = useState('');
  const [audioIntensity, setAudioIntensity] = useState(0);

  // Find the track by ID
  const track = useMemo(() => {
    if (!id) return currentTrack;
    
    // First try to find in the feed store tracks
    const foundTrack = tracks.find(t => t.id === id);
    if (foundTrack) return foundTrack;
    
    // If not found and we have a current track, check if it matches
    if (currentTrack && currentTrack.id === id) return currentTrack;
    
    // If we still don't have a track, return null to show the not found message
    return null;
  }, [id, tracks, currentTrack]);

  // Calculate isTrackPlaying for the visualizer
  const isCurrentTrack = currentTrack?.id === track?.id;
  const isTrackPlaying = isCurrentTrack && isPlaying;

  // Get the global audio element for visualization
  const globalAudio = getGlobalAudio();

  // Simuliere pulsierendes Feedback basierend auf isPlaying
  useEffect(() => {
    if (!isTrackPlaying) {
      setAudioIntensity(0);
      return;
    }

    let animationFrameId: number;
    let startTime = Date.now();

    const updatePulse = () => {
      const elapsed = Date.now() - startTime;
      // Sinus-Welle f√ºr kontinuierliches Pulsieren (0.5 Hz = 2 Sekunden pro Zyklus)
      const intensity = 0.3 + 0.3 * Math.sin(elapsed / 1000 * Math.PI);
      setAudioIntensity(intensity);
      animationFrameId = requestAnimationFrame(updatePulse);
    };

    updatePulse();

    return () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    };
  }, [isTrackPlaying]);
  
  // Audio-Analyser entfernt wegen CORS-Problemen
  useEffect(() => {
    if (!isTrackPlaying) {
      setAudioIntensity(0);
      return;
    }

    const analyser = getGlobalAudioAnalyser();
    if (!analyser) {
      console.warn('Audio analyser not available');
      return;
    }

    let animationFrameId: number;

    const updateAudioIntensity = () => {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);

      // Berechne RMS (Root Mean Square) f√ºr Intensit√§t
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i] * dataArray[i];
      }
      const rms = Math.sqrt(sum / dataArray.length);
      const intensity = Math.max(rms / 255, 0.05) * 2; // Verst√§rkt f√ºr bessere Sichtbarkeit
      
      setAudioIntensity(intensity);
      animationFrameId = requestAnimationFrame(updateAudioIntensity);
    };

    updateAudioIntensity();

    return () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    };
  }, [isTrackPlaying]);

  useEffect(() => {
    expand();
    return () => collapse();
  }, [expand, collapse]);

  // When we have a track but no current track is set, set it as the current track
  useEffect(() => {
    if (track && (!currentTrack || currentTrack.id !== track.id)) {
      setCurrentTrack(track);
    }
  }, [track, currentTrack, setCurrentTrack]);
  
  if (!track) {
    return (
      <div className="max-w-md mx-auto px-4 py-6 pb-24">
        <div className="true-black-card text-center">
          <h2 className="text-lg font-medium text-text-primary mb-2">Track not found</h2>
          <button 
            onClick={() => navigate('/')}
            className="text-accent-blue hover:underline"
          >
            Go back to feed
          </button>
        </div>
      </div>
    );
  }

  // Fix for Infinity:NaN issue - ensure we have valid numbers
  const safeCurrentTime = isFinite(currentTime) && !isNaN(currentTime) ? currentTime : 0;
  const safeDuration = isFinite(duration) && !isNaN(duration) ? duration : 0;
  // Ensure progress is always between 0 and 100
  const progress = safeDuration > 0 ? Math.min(100, Math.max(0, (safeCurrentTime / safeDuration) * 100)) : 0;

  const handleProgressClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (!safeDuration) return;
    
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const percentage = x / rect.width;
    const newTime = percentage * safeDuration;
    
    seek(newTime);
  };

  const handleSkipBackward = () => {
    const newTime = Math.max(0, safeCurrentTime - 15);
    seek(newTime);
  };

  const handleSkipForward = () => {
    const newTime = Math.min(safeDuration, safeCurrentTime + 15);
    seek(newTime);
  };

  const handleLike = () => {
    console.log('‚ù§Ô∏è PlayerPage: Like button clicked for track:', track.id);
    const success = currentUser?.id ? toggleLike(track.id, currentUser.id) : false;
    console.log('‚ù§Ô∏è PlayerPage: Like result:', success);
  };

  const handleComment = () => {
    // Navigate to comments page
    navigate(`/comments`);
  };

  const handleAddComment = () => {
    if (commentText.trim() && track && currentUser) {
      const newComment = {
        id: `comment-${Date.now()}`,
        content: commentText.trim(),
        user: currentUser,
        createdAt: new Date(),
        likes: 0,
        isLiked: false
      };
      console.log('üí¨ PlayerPage: Adding comment to track:', track.id);
      const success = addCommentToTrack(track.id, newComment);
      console.log('üí¨ PlayerPage: Comment result:', success);
      if (success) {
        setCommentText('');
      }
    }
  };

  const handleBookmark = () => {
    console.log('üîñ PlayerPage: Bookmark button clicked for track:', track.id);
    const success = currentUser?.id ? toggleBookmark(track.id, currentUser.id) : false;
    console.log('üîñ PlayerPage: Bookmark result:', success);
  };

  // Handle comment like interaction
  const handleCommentLike = (commentId: string) => {
    console.log('Comment like clicked:', commentId);
    const success = currentUser?.id ? toggleCommentLike(commentId, currentUser.id) : false;
    if (success) {
      console.log('Comment like toggled successfully');
    } else {
      console.error('Failed to toggle comment like');
    }
  };


  // Handle play button click with better error handling
  const handlePlayClick = () => {
    // Ensure we have a track before trying to play
    if (track) {
      console.log('Attempting to play track:', track.title);
      console.log('Track URL:', track.url);
      console.log('Current track in store:', currentTrack?.title);
      console.log('Is playing:', isPlaying);
      console.log('Global audio readyState:', globalAudio?.readyState);
      console.log('Global audio networkState:', globalAudio?.networkState);
      
      // Toggle play state
      toggle();
    } else {
      console.log('No track available to play');
    }
  };

  // Get track comments - only show real comments, no sample comments
  // Get comments for this track from the database
  const trackComments = comments.filter(comment => comment.trackId === track.id);

  return (
    <div className="max-w-md mx-auto min-h-screen relative bg-transparent">
      {/* Radialer Audio-Feedback beim Abspielen */}
      {isTrackPlaying && (
        <>
            {/* Hintergrund-R√∂tung - pulsierend */}
            <div
              className="fixed pointer-events-none"
              style={{
                zIndex: 1,
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: `rgba(220, 50, 40, ${0.08 + audioIntensity * 0.25})`,
                mixBlendMode: 'screen',
                transition: 'background-color 0.06s linear',
              }}
            />
            
            {/* Radialer Verlauf - pulsierend */}
            <div
              className="fixed pointer-events-none"
              style={{
                zIndex: 5,
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                mixBlendMode: 'screen',
                background: `radial-gradient(circle at 50% 45%, 
                  rgba(220, 50, 40, ${0.3 + audioIntensity * 0.5}) 0%,
                  rgba(180, 30, 25, ${0.25 + audioIntensity * 0.45}) ${3 + audioIntensity * 30}%,
                  rgba(150, 20, 15, ${0.2 + audioIntensity * 0.4}) ${8 + audioIntensity * 50}%,
                  rgba(120, 15, 10, ${0.1 + audioIntensity * 0.25}) ${15 + audioIntensity * 65}%,
                  transparent ${Math.min(30 + audioIntensity * 70, 100)}%
                )`,
                transition: 'background 0.06s linear',
              }}
            />
        </>
      )}
      
      {/* Spacer for fixed header */}
      <div className="h-[72px]"></div>

      <div className="px-6 pb-6 min-h-[calc(100vh-72px)] flex flex-col"> {/* Adjusted padding and height */}
        {/* Username and statistics line */}
        <div className="flex items-center space-x-2 mb-4">
          <button 
            onClick={() => navigate(`/profile/${track.user?.username || 'unknown'}`)}
            className="flex items-center space-x-1 text-gray-400 text-xs hover:text-white transition-colors cursor-pointer"
          >
            <User size={12} strokeWidth={2} />
            <span>{track.user?.username || 'Unknown'}</span>
          </button>
          <div className="flex items-center space-x-1">
            <Play 
              size={14} strokeWidth={2} 
              className="text-gray-400"
              fill="none"
            />
            <span className="text-gray-400 text-xs">{track.plays || 0}</span>
          </div>
          <div className="flex items-center space-x-1">
            <Heart 
              size={14} strokeWidth={2} 
              className="text-gray-400"
              fill="none"
            />
            <span className="text-gray-400 text-xs">{track.likes}</span>
          </div>
          <div className="flex items-center space-x-1">
            <MessageCircle size={14} strokeWidth={1.5} className="text-gray-400" />
            <span className="text-gray-400 text-xs">{track.commentsCount || trackComments.length}</span>
          </div>
          {track.createdAt && (
            <div className="flex items-center space-x-1">
              <Calendar size={14} strokeWidth={1.5} className="text-gray-400" />
              <span className="text-gray-400 text-xs">
                {new Date(track.createdAt).toLocaleDateString('de-DE', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                })}
              </span>
            </div>
          )}
        </div>

        {/* Title - large and white */}
        <h1 className="text-white text-4xl font-bold leading-tight mb-4">
          {track.title}
        </h1>

        {/* Description - gray and smaller */}
        <p className="text-gray-400 mb-6 leading-snug text-xs">
          {track.description || "Intimate whispers sharing personal thoughts and desires"}
        </p>

        {/* Tags - flexible height */}
        <div className="flex flex-wrap gap-2 mb-10">
          {(() => {
            const tags = track.tags || ['Soft', 'Female', 'Toy', 'Whisper', 'Intimate'];
            const genderTags = ['Female', 'Male', 'Couple', 'Diverse'];
            
            // Find gender tag and move it to the front
            const genderTag = tags.find(tag => genderTags.includes(tag));
            const otherTags = tags.filter(tag => !genderTags.includes(tag));
            
            // Sort tags: gender first, then others
            const sortedTags = genderTag ? [genderTag, ...otherTags] : otherTags;
            
            return sortedTags.map((tag, index) => (
              <span
                key={index}
                className="border border-gray-500 px-4 py-1.5 text-gray-400 text-xs font-medium rounded-full flex items-center gap-1"
              >
                <span className="text-gray-500">#</span>
                {tag}
              </span>
            ));
          })()}
        </div>

        {/* Play button with skip buttons centered vertically in page */}
        <div className="flex justify-between items-center my-16 relative">
          {/* Skip backward button */}
          <button
            onClick={handleSkipBackward}
            className="flex items-center justify-center transition-all duration-200 hover:scale-105 active:scale-95"
            aria-label="15 Sekunden zur√ºck"
            title="15 Sekunden zur√ºck"
          >
            <svg width="36" height="36" viewBox="0 0 90.675 81.032" className="text-white">
              <g>
                <path style={{fill:"none",stroke:"white",strokeWidth:"4",strokeMiterlimit:"10"}} d="M50.166,78.872c21.184,0,38.356-17.173,38.356-38.356
                  S71.35,2.16,50.166,2.16s-38.356,17.173-38.356,38.356"/>
                <polyline style={{fill:"none",stroke:"white",strokeWidth:"4",strokeMiterlimit:"10"}} points="1.306,27.653 11.809,40.569 24.726,30.066"/>
                <text x="48.338" y="50" textAnchor="middle" fontSize="29" fill="white" fontFamily="monospace" fontWeight="900" stroke="white" strokeWidth="1.5">15</text>
              </g>
            </svg>
          </button>
          
          {/* Play button with visualizer - like on Record page */}
          <div className="relative flex items-center justify-center">
            {/* Unicorn Beam Audio Visualizer as container */}
            <UnicornBeamAudioVisualizer
              frequencies={[]}
              volume={0}
              isActive={isTrackPlaying}
              size="medium"
              className="relative"
            />
            
            {/* Play Button - positioned over the visualizer */}
            <button
              onClick={handlePlayClick}
              className="absolute z-10 rounded-full bg-transparent backdrop-blur-sm flex items-center justify-center shadow-voice overflow-visible"
              aria-label={isTrackPlaying ? 'Pause' : 'Play'}
              style={{
                width: '100px',
                height: '100px',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                aspectRatio: '1/1',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: 0,
                padding: 0
              }}
            >
              <DynamicPlayIcon
                isCurrentTrack={isCurrentTrack}
                isPlaying={isTrackPlaying}
                isFinished={false}
                variant="white-outline"
              />
            </button>
          </div>
          
          {/* Skip forward button */}
          <button
            onClick={handleSkipForward}
            className="flex items-center justify-center transition-all duration-200 hover:scale-105 active:scale-95"
            aria-label="15 Sekunden vor"
            title="15 Sekunden vor"
          >
            <svg width="36" height="36" viewBox="0 0 90.675 81.032" className="text-white">
              <g>
                <path style={{fill:"none",stroke:"white",strokeWidth:"4",strokeMiterlimit:"10"}} d="M40.509,78.872c-21.184,0-38.356-17.173-38.356-38.356
                  S19.326,2.16,40.509,2.16s38.356,17.173,38.356,38.356"/>
                <polyline style={{fill:"none",stroke:"white",strokeWidth:"4",strokeMiterlimit:"10"}} points="89.369,27.653 78.866,40.569 65.949,30.066"/>
                <text x="42.338" y="50" textAnchor="middle" fontSize="29" fill="white" fontFamily="monospace" fontWeight="900" stroke="white" strokeWidth="1.5">15</text>
              </g>
            </svg>
          </button>
        </div>
        
        {/* Progress Bar with time displays - 10px above comments/buttons */}
        <div className="mt-8 mb-2.5 px-6 -mx-6">
          <div className="flex items-center gap-[15px]">
            {/* Left time display */}
            <span className="text-gray-400 text-xs font-mono min-w-[40px] text-left">
              {formatDuration(safeCurrentTime)}
            </span>
            
            {/* Progress bar */}
            <div 
              className="h-0.5 bg-gray-700 rounded-full cursor-pointer hover:h-1 transition-all duration-200"
              onClick={handleProgressClick}
              title={`${formatDuration(safeCurrentTime)} / ${formatDuration(safeDuration)}`}
              style={{ width: 'calc(100% - 110px)' }}
            >
              <div 
                className="h-full bg-[#ff4e3a] rounded-full transition-all duration-100"
                style={{ width: `${progress}%` }}
              />
            </div>
            
            {/* Right time display */}
            <span className="text-gray-400 text-xs font-mono min-w-[40px] text-right">
              {formatDuration(safeDuration)}
            </span>
          </div>
        </div>
        
        {/* Comment input and action buttons at the bottom of content */}
        <div className="mt-4 py-4 px-6 flex items-center gap-[15px] bg-transparent backdrop-blur-sm -mx-6" style={{ marginTop: '20px' }}>
          <div className="relative flex-1">
            <input
              type="text"
              placeholder="comment ‚Ä¶"
              className="w-full h-10 px-4 bg-transparent border rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-[#ff4e3a] focus:bg-[#ff4e3a]/5 transition-all duration-200 border-gray-500"
              value={commentText}
              onChange={(e) => setCommentText(e.target.value)}
              onKeyPress={(e) => {
                if (e.key === 'Enter') {
                  handleAddComment();
                }
              }}
            />
            <button
              onClick={handleAddComment}
              disabled={!commentText.trim()}
              className="absolute right-[5px] top-1/2 transform -translate-y-1/2 text-gray-300 hover:text-white transition-colors w-10 h-10 flex items-center justify-center"
            >
              <Send size={16} strokeWidth={2} />
            </button>
          </div>
          
          {/* Button group with minimal spacing */}
          <div className="flex items-center gap-1">
            <button
              onClick={handleLike}
              className={`w-10 h-10 min-w-[40px] min-h-[40px] max-w-[40px] max-h-[40px] rounded-full border-2 border-gray-600 bg-gradient-to-r from-gray-700/30 to-gray-600/20 flex items-center justify-center transition-all duration-200 hover:from-gray-600/40 hover:to-gray-500/30 active:from-gray-600/50 active:to-gray-500/40 ${
                track.isLiked 
                  ? "border-red-500 bg-gradient-to-r from-red-500/30 to-red-600/20" 
                  : ""
              }`}
              style={{ aspectRatio: '1/1' }}
              title={track.isLiked ? 'Unlike' : 'Like'}
            >
              <Heart 
                size={16} 
                strokeWidth={2}
                className={`transition-all duration-200 ${
                  track.isLiked 
                    ? "fill-red-500 text-red-500" 
                    : "text-gray-300"
                }`}
              />
            </button>
            
            <button
              onClick={handleBookmark}
              className={`w-10 h-10 min-w-[40px] min-h-[40px] max-w-[40px] max-h-[40px] rounded-full border-2 border-gray-600 bg-gradient-to-r from-gray-700/30 to-gray-600/20 flex items-center justify-center transition-all duration-200 hover:from-gray-600/40 hover:to-gray-500/30 active:from-gray-600/50 active:to-gray-500/40 ${
                track.isBookmarked 
                  ? "border-yellow-500 bg-gradient-to-r from-yellow-500/30 to-yellow-600/20" 
                  : ""
              }`}
              style={{ aspectRatio: '1/1' }}
              title={track.isBookmarked ? 'Remove bookmark' : 'Bookmark'}
            >
              <Bookmark 
                size={16} 
                strokeWidth={2}
                className={`transition-all duration-200 ${
                  track.isBookmarked 
                    ? "fill-yellow-500 text-yellow-500" 
                    : "text-gray-300"
                }`}
              />
            </button>
          </div>
        </div>
        
        {/* Comments section - visible when scrolling */}
        <div className="mt-4">
          {trackComments.length > 0 ? (
            <div className="space-y-4">
              {trackComments.map((comment) => {
                const [isLiked, setIsLiked] = useState(false);
                const [likeCount, setLikeCount] = useState(0);
                
                useEffect(() => {
                  const loadCommentData = async () => {
                    try {
                      const [liked, count] = await Promise.all([
                        isCommentLikedByUser(comment.id, 'user-1'),
                        getCommentLikeCount(comment.id)
                      ]);
                      setIsLiked(liked);
                      setLikeCount(count);
                    } catch (error) {
                      console.error('Error loading comment data:', error);
                    }
                  };
                  loadCommentData();
                }, [comment.id]);
                
                return (
                  <div key={comment.id} className="border-b border-gray-800 pb-4">
                    <div className="flex items-center mb-2">
                      <span className="text-[#ff4e3a] text-sm font-medium">{comment.user.username}</span>
                      <span className="text-gray-500 text-xs ml-2">
                        {new Date(comment.createdAt).toLocaleDateString('de-DE')}
                      </span>
                    </div>
                    <p className="text-gray-300 text-sm">{comment.content}</p>
                    <div className="flex items-center mt-2">
                      <button 
                        onClick={() => handleCommentLike(comment.id)}
                        className="flex items-center space-x-1 text-gray-400 hover:text-white transition-colors"
                      >
                        <Heart 
                          size={14} strokeWidth={2} 
                          className={isLiked ? "fill-red-500 text-red-500" : ""} 
                        />
                        {likeCount > 0 && (
                          <span className="text-xs">{likeCount}</span>
                        )}
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-8">
              <MessageCircle className="w-8 h-8 text-gray-600 mx-auto mb-2" />
              <p className="text-gray-500 text-sm">No comments yet</p>
              <p className="text-gray-600 text-xs mt-1">Be the first to comment!</p>
            </div>
          )}
        </div>

        {/* Report Link - centered at bottom */}
        <div className="mt-8 pt-6">
          <div className="text-center">
            <button
              onClick={() => navigate('/report', { 
                state: { 
                  trackInfo: track, 
                  trackId: track.id 
                } 
              })}
              className="flex items-center justify-center space-x-2 text-gray-400 hover:text-red-400 text-sm transition-colors mx-auto"
            >
              <Flag size={14} strokeWidth={1.5} />
              <span>Report inappropriate content</span>
            </button>
          </div>
        </div>
      </div>

    </div>
  );
};