import { DatabaseServiceV2 } from '../services/databaseService_v2';
import { autoMigrate } from '../database/migration';
import type { AudioTrack, User, Notification, PendingUpload, Follow } from '../types';

// Beispiel-Script f√ºr die neue V2-Datenbank
export class DatabaseV2Example {
  
  // Beispiel: Migration durchf√ºhren
  static async runMigration(): Promise<void> {
    console.log('üöÄ Beispiel: Starte Migration...');
    
    const success = await autoMigrate();
    
    if (success) {
      console.log('‚úÖ Beispiel: Migration erfolgreich abgeschlossen');
    } else {
      console.log('‚ùå Beispiel: Migration fehlgeschlagen');
    }
  }

  // Beispiel: Tracks abrufen und anzeigen
  static displayTracks(): void {
    console.log('üìö Beispiel: Zeige alle Tracks...');
    
    const tracks = DatabaseServiceV2.getTracks();
    console.log(`Gefunden: ${tracks.length} Tracks`);
    
    tracks.forEach(track => {
      console.log(`- ${track.title} von ${track.user.username} (${track.likes} Likes, ${track.plays || 0} Plays)`);
      if (track.tags && track.tags.length > 0) {
        console.log(`  Tags: ${track.tags.join(', ')}`);
      }
    });
  }

  // Beispiel: Follow-System verwenden
  static demonstrateFollowSystem(): void {
    console.log('üë• Beispiel: Follow-System...');
    
    const userId = 'user-1';
    const targetUserId = '4'; // Holler die Waldfee
    
    // Pr√ºfe, ob bereits gefolgt wird
    const isFollowing = DatabaseServiceV2.isFollowing(userId, targetUserId);
    console.log(`User ${userId} folgt User ${targetUserId}: ${isFollowing}`);
    
    if (!isFollowing) {
      // Folge dem User
      const success = DatabaseServiceV2.follow(userId, targetUserId);
      console.log(`Follow erfolgreich: ${success}`);
    }
    
    // Zeige Following-Liste
    const following = DatabaseServiceV2.getFollowing(userId);
    console.log(`User ${userId} folgt:`, following.map(u => u.username));
    
    // Zeige Followers-Liste
    const followers = DatabaseServiceV2.getFollowers(targetUserId);
    console.log(`User ${targetUserId} hat ${followers.length} Follower:`, followers.map(u => u.username));
  }

  // Beispiel: Following-Feed abrufen
  static demonstrateFollowingFeed(): void {
    console.log('üì∞ Beispiel: Following-Feed...');
    
    const userId = 'user-1';
    const followingFeed = DatabaseServiceV2.getFollowingFeed(userId);
    
    console.log(`Following-Feed f√ºr User ${userId}: ${followingFeed.length} Tracks`);
    followingFeed.forEach(track => {
      console.log(`- ${track.title} von ${track.user.username} (${new Date(track.createdAt).toLocaleDateString()})`);
    });
  }

  // Beispiel: Bookmarks verwenden
  static demonstrateBookmarks(): void {
    console.log('üîñ Beispiel: Bookmark-System...');
    
    const userId = 'user-1';
    const trackId = 'holla-1';
    
    // Bookmark hinzuf√ºgen
    const success = DatabaseServiceV2.toggleBookmark(trackId, userId);
    console.log(`Bookmark hinzugef√ºgt: ${success}`);
    
    // Bookmarked Tracks abrufen
    const bookmarkedTracks = DatabaseServiceV2.getUserBookmarkedTracks(userId);
    console.log(`Bookmarked Tracks f√ºr User ${userId}: ${bookmarkedTracks.length}`);
    bookmarkedTracks.forEach(track => {
      console.log(`- ${track.title} von ${track.user.username}`);
    });
  }

  // Beispiel: Top Tags abrufen
  static demonstrateTopTags(): void {
    console.log('üè∑Ô∏è Beispiel: Top Tags...');
    
    const topTags = DatabaseServiceV2.getTopTags();
    console.log(`Top ${topTags.length} Tags:`);
    topTags.forEach((tag, index) => {
      console.log(`${index + 1}. ${tag.tag} (${tag.count} mal verwendet)`);
    });
  }

  // Beispiel: Notifications verwenden
  static demonstrateNotifications(): void {
    console.log('üîî Beispiel: Notification-System...');
    
    const userId = 'user-1';
    
    // Notification hinzuf√ºgen
    const notification: Omit<Notification, 'id' | 'createdAt'> = {
      userId,
      type: 'UPLOAD_APPROVED',
      payload: { trackId: 'holla-1', title: 'Intime Fl√ºsterstimme' }
    };
    
    const newNotification = DatabaseServiceV2.addNotification(notification);
    console.log(`Notification hinzugef√ºgt: ${newNotification.id}`);
    
    // Notifications abrufen
    const notifications = DatabaseServiceV2.getUserNotifications(userId);
    console.log(`Notifications f√ºr User ${userId}: ${notifications.length}`);
    notifications.forEach(notif => {
      console.log(`- ${notif.type}: ${JSON.stringify(notif.payload)} (${notif.readAt ? 'gelesen' : 'ungelesen'})`);
    });
  }

  // Beispiel: Pending Uploads verwenden
  static demonstratePendingUploads(): void {
    console.log('‚è≥ Beispiel: Pending Uploads...');
    
    // Pending Upload hinzuf√ºgen
    const pendingUpload: Omit<PendingUpload, 'id' | 'createdAt'> = {
      userId: 'user-1',
      deviceId: 'device-123',
      fileHash: 'sha256:abc123...',
      reason: 'rate',
      status: 'pending'
    };
    
    const newPending = DatabaseServiceV2.addPendingUpload(pendingUpload);
    console.log(`Pending Upload hinzugef√ºgt: ${newPending.id}`);
    
    // Pending Uploads auflisten
    const pendingUploads = DatabaseServiceV2.listPendingUploads();
    console.log(`Pending Uploads: ${pendingUploads.length}`);
    pendingUploads.forEach(pending => {
      console.log(`- ${pending.id}: ${pending.reason} (${pending.status})`);
    });
    
    // Pending Upload freigeben (Admin-Funktion)
    const adminId = 'admin-1';
    const approved = DatabaseServiceV2.approvePendingUpload(newPending.id, adminId);
    console.log(`Pending Upload freigegeben: ${approved}`);
  }

  // Beispiel: Comment Likes verwenden
  static demonstrateCommentLikes(): void {
    console.log('‚ù§Ô∏è Beispiel: Comment Likes...');
    
    const commentId = 'comment-1';
    const userId = 'user-1';
    
    // Comment Like hinzuf√ºgen
    const success = DatabaseServiceV2.toggleCommentLike(commentId, userId);
    console.log(`Comment Like hinzugef√ºgt: ${success}`);
    
    // Comment Like Status pr√ºfen
    const isLiked = DatabaseServiceV2.isCommentLikedByUser(commentId, userId);
    console.log(`Comment ${commentId} von User ${userId} geliked: ${isLiked}`);
    
    // Comment Like Count abrufen
    const likeCount = DatabaseServiceV2.getCommentLikeCount(commentId);
    console.log(`Comment ${commentId} hat ${likeCount} Likes`);
  }

  // Beispiel: Play Tracking verwenden
  static demonstratePlayTracking(): void {
    console.log('‚ñ∂Ô∏è Beispiel: Play Tracking...');
    
    const trackId = 'holla-1';
    
    // Play Count erh√∂hen
    const success = DatabaseServiceV2.incrementPlay(trackId);
    console.log(`Play Count erh√∂ht: ${success}`);
    
    // Play Count abrufen
    const playCount = DatabaseServiceV2.getPlayCount(trackId);
    console.log(`Track ${trackId} wurde ${playCount} mal abgespielt`);
  }

  // Beispiel: Suche verwenden
  static demonstrateSearch(): void {
    console.log('üîç Beispiel: Suche...');
    
    // Suche nach "ASMR"
    const asmrTracks = DatabaseServiceV2.searchTracks('ASMR');
    console.log(`Suche nach "ASMR": ${asmrTracks.length} Tracks gefunden`);
    asmrTracks.forEach(track => {
      console.log(`- ${track.title} von ${track.user.username}`);
    });
    
    // Suche nach "holla"
    const hollaTracks = DatabaseServiceV2.searchTracks('holla');
    console.log(`Suche nach "holla": ${hollaTracks.length} Tracks gefunden`);
  }

  // Beispiel: Sortierung verwenden
  static demonstrateSorting(): void {
    console.log('üìä Beispiel: Sortierung...');
    
    // Nach Likes sortieren
    const tracksByLikes = DatabaseServiceV2.getTracksSorted('likes', 'desc');
    console.log('Tracks nach Likes sortiert:');
    tracksByLikes.slice(0, 3).forEach(track => {
      console.log(`- ${track.title}: ${track.likes} Likes`);
    });
    
    // Nach Plays sortieren
    const tracksByPlays = DatabaseServiceV2.getTracksSorted('plays', 'desc');
    console.log('Tracks nach Plays sortiert:');
    tracksByPlays.slice(0, 3).forEach(track => {
      console.log(`- ${track.title}: ${track.plays || 0} Plays`);
    });
  }

  // Beispiel: Validierung verwenden
  static demonstrateValidation(): void {
    console.log('‚úÖ Beispiel: Validierung...');
    
    // Track validieren
    const validTrack: Partial<AudioTrack> = {
      title: 'Test Track',
      url: 'data:audio/wav;base64,test',
      duration: 120,
      tags: ['Test', 'Valid']
    };
    
    const trackValidation = DatabaseServiceV2.validateTrack(validTrack);
    console.log(`Track-Validierung: ${trackValidation.isValid ? 'G√ºltig' : 'Ung√ºltig'}`);
    if (!trackValidation.isValid) {
      console.log('Fehler:', trackValidation.errors);
    }
    
    // Follow validieren
    const followValidation = DatabaseServiceV2.validateFollow('user-1', 'user-2');
    console.log(`Follow-Validierung: ${followValidation.isValid ? 'G√ºltig' : 'Ung√ºltig'}`);
    if (!followValidation.isValid) {
      console.log('Fehler:', followValidation.errors);
    }
  }

  // Beispiel: Statistiken anzeigen
  static displayStats(): void {
    console.log('üìä Beispiel: Statistiken...');
    
    const stats = DatabaseServiceV2.getStats();
    console.log('Datenbank-Statistiken:');
    console.log(`- Benutzer: ${stats.totalUsers}`);
    console.log(`- Tracks: ${stats.totalTracks}`);
    console.log(`- Kommentare: ${stats.totalComments}`);
    console.log(`- Likes: ${stats.totalLikes}`);
    console.log(`- Bookmarks: ${stats.totalBookmarks}`);
    console.log(`- Plays: ${stats.totalPlays}`);
    console.log(`- Notifications: ${stats.totalNotifications}`);
    console.log(`- Pending Uploads: ${stats.totalPendingUploads}`);
    console.log(`- Follows: ${stats.totalFollows}`);
    console.log(`- Dateigr√∂√üe: ${(stats.totalFileSize / 1024 / 1024).toFixed(2)} MB`);
  }

  // F√ºhre alle Beispiele aus
  static async runAllExamples(): Promise<void> {
    console.log('üöÄ Beispiel: Starte alle Beispiele...');
    
    try {
      // 1. Migration
      await this.runMigration();
      
      // 2. Grundlegende Funktionen
      this.displayTracks();
      this.displayStats();
      
      // 3. Follow-System
      this.demonstrateFollowSystem();
      this.demonstrateFollowingFeed();
      
      // 4. Bookmarks
      this.demonstrateBookmarks();
      
      // 5. Top Tags
      this.demonstrateTopTags();
      
      // 6. Notifications
      this.demonstrateNotifications();
      
      // 7. Pending Uploads
      this.demonstratePendingUploads();
      
      // 8. Comment Likes
      this.demonstrateCommentLikes();
      
      // 9. Play Tracking
      this.demonstratePlayTracking();
      
      // 10. Suche und Sortierung
      this.demonstrateSearch();
      this.demonstrateSorting();
      
      // 11. Validierung
      this.demonstrateValidation();
      
      console.log('‚úÖ Beispiel: Alle Beispiele erfolgreich ausgef√ºhrt');
      
    } catch (error) {
      console.error('‚ùå Beispiel: Fehler beim Ausf√ºhren der Beispiele:', error);
    }
  }
}

// Export f√ºr einfache Verwendung
export default DatabaseV2Example;
