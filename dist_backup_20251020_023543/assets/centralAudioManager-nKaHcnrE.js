import{a as n,A as g,b as i}from"./index-D0bHzwAf.js";class h{storage=new Map;STORAGE_KEY="aural_simple_blob_storage";constructor(){this.loadFromLocalStorage()}loadFromLocalStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const o=JSON.parse(e);Object.entries(o).forEach(([a,r])=>{if(r.base64){const t=this.base64ToBlob(r.base64,r.metadata.type);t&&this.storage.set(a,{id:a,blob:t,metadata:r.metadata})}}),n.info("manager","Loaded blobs from localStorage",{count:this.storage.size})}}catch(e){n.error("manager","Failed to load blobs from localStorage",{error:e.message})}}saveToLocalStorage(){try{const e={};this.storage.forEach((o,a)=>{e[a]={base64:this.blobToBase64(o.blob),metadata:o.metadata}}),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),n.info("manager","Saved blobs to localStorage",{count:this.storage.size})}catch(e){n.error("manager","Failed to save blobs to localStorage",{error:e.message})}}async storeBlob(e,o,a={}){const r={id:e,blob:o,metadata:{title:a.title||`Blob ${e}`,size:o.size,type:o.type,createdAt:Date.now(),...a}};this.storage.set(e,r),this.saveToLocalStorage(),n.info("manager","Blob stored successfully",{id:e,size:o.size,type:o.type},e)}async getBlob(e){const o=this.storage.get(e);return o?(n.info("manager","Blob retrieved successfully",{id:e,size:o.blob.size,age:Date.now()-o.metadata.createdAt},e),o.blob):(n.warn("manager","Blob not found",{id:e},e),null)}async createBlobUrl(e){const o=await this.getBlob(e);if(o){const a=URL.createObjectURL(o);return n.info("manager","Blob URL created",{id:e,url:a}),a}return null}async deleteBlob(e){this.storage.has(e)&&(this.storage.delete(e),this.saveToLocalStorage(),n.info("manager","Blob deleted",{id:e},e))}getAllBlobIds(){return Array.from(this.storage.keys())}getStats(){const e=Array.from(this.storage.values()),o=e.reduce((r,t)=>r+t.metadata.size,0),a=e.map(r=>r.metadata.createdAt);return{count:e.length,totalSize:o,oldestBlob:a.length>0?Math.min(...a):0,newestBlob:a.length>0?Math.max(...a):0}}cleanup(e=10080*60*1e3){const o=Date.now()-e,a=[];this.storage.forEach((r,t)=>{r.metadata.createdAt<o&&a.push(t)}),a.forEach(r=>{this.storage.delete(r),n.info("manager","Cleaned up old blob",{id:r},r)}),a.length>0&&(this.saveToLocalStorage(),n.info("manager","Cleanup completed",{deletedCount:a.length}))}blobToBase64(e){return e.size<10*1024*1024?"data:"+e.type+";base64,"+btoa(String.fromCharCode(...new Uint8Array(e))):"large_blob_"+e.size+"_"+e.type}base64ToBlob(e,o){try{if(e.startsWith("data:")){const[a,r]=e.split(","),t=atob(r),u=new Array(t.length);for(let d=0;d<t.length;d++)u[d]=t.charCodeAt(d);const b=new Uint8Array(u);return new Blob([b],{type:o})}return null}catch(a){return n.error("manager","Failed to convert Base64 to Blob",{error:a.message}),null}}}const l=new h;setInterval(()=>{l.cleanup()},1440*60*1e3);typeof window<"u"&&(window.simpleBlobStorage=l,window.getSimpleBlobStats=()=>l.getStats(),window.getAllSimpleBlobIds=()=>l.getAllBlobIds(),window.cleanupSimpleBlobs=()=>l.cleanup());const m=(s,e)=>{console.log("storeBlob called",s,e)},f=s=>(console.log("createBlobUrl called",s),"");class A{isInitialized=!1;async initialize(){if(!this.isInitialized){console.log("ğŸš€ CentralAudioManager: Initializing...");try{await this.migrateExistingAudioData(),this.isInitialized=!0,console.log("âœ… CentralAudioManager: Initialized successfully")}catch(e){throw console.error("âŒ CentralAudioManager: Initialization failed:",e),e}}}async migrateExistingAudioData(){console.log("ğŸ”„ CentralAudioManager: Migrating existing audio data...");try{const e=window.database||{};if(e.tracks){let o=0;for(const a of e.tracks)if(a.url&&a.url.startsWith("blob:")){const r=g.getUrlInfo(a.id);r&&r.originalBlob&&(await i.storeAudio(a.id,r.originalBlob),o++)}console.log(`âœ… CentralAudioManager: Migrated ${o} audio files`)}}catch(e){console.error("âŒ CentralAudioManager: Migration failed:",e)}}async storeNewAudio(e,o){console.log("ğŸµ CentralAudioManager: Storing new audio:",e);try{m(e,o);const a=f(e);if(!a)throw new Error("Failed to create blob URL");return await l.storeBlob(e,o,{title:`Track ${e}`,size:o.size,type:o.type}),await g.storeAudioUrl(e,o,"base64"),await i.storeAudio(e,o),console.log("âœ… CentralAudioManager: New audio stored successfully with multiple fallbacks"),console.log("ğŸ“Š Storage details:",{trackId:e,blobSize:o.size,urlType:"blob",storedIn:["InMemory","SimpleBlobStorage","AudioUrlManager","AudioPersistenceManager"]}),a}catch(a){throw console.error("âŒ CentralAudioManager: Error storing new audio:",a),a}}async loadAudioForPlayback(e){console.log("ğŸµ CentralAudioManager: Loading audio for playback:",e.id);try{let o=f(e.id);if(o)return console.log("âœ… CentralAudioManager: Audio loaded from InMemory storage"),o;if(o=i.getAudio(e.id),o)return console.log("âœ… CentralAudioManager: Audio loaded from persistence manager"),o;if(o=g.getAudioUrl(e.id),o&&o.startsWith("data:audio/"))return console.log("âœ… CentralAudioManager: Audio loaded from URL manager"),o;const a=await i.createTemporaryBlobUrl(e.id);return a?(console.log("âœ… CentralAudioManager: Temporary blob URL created"),a):(o=await this.loadAudioFromServer(e),o?(console.log("âœ… CentralAudioManager: Audio loaded from server"),o):(console.log("âŒ CentralAudioManager: No audio source found"),null))}catch(o){return console.error("âŒ CentralAudioManager: Error loading audio:",o),null}}async loadAudioFromServer(e){try{console.log("ğŸŒ CentralAudioManager: Loading audio from server:",e.id);const o=this.generateServerPaths(e);for(const a of o)try{console.log("ğŸ” CentralAudioManager: Trying server path:",a);const r=await fetch(a);if(r.ok){const t=await r.blob();if(t.type.startsWith("audio/"))return console.log("âœ… CentralAudioManager: Found audio on server:",a),await i.storeAudio(e.id,t),await this.blobToBase64(t)}}catch(r){console.log("âŒ CentralAudioManager: Server path failed:",a,r)}return null}catch(o){return console.error("âŒ CentralAudioManager: Error loading from server:",o),null}}generateServerPaths(e){const o=[];e.filename&&o.push(`https://www.goaural.com/uploads/${e.filename}`),e.user?.username&&e.filename&&o.push(`https://www.goaural.com/uploads/${e.user.username}/${e.filename}`);const a=["wav","mp3","webm","ogg","m4a"];for(const r of a)o.push(`https://www.goaural.com/uploads/${e.id}.${r}`),o.push(`https://www.goaural.com/uploads/audio_${e.id}.${r}`);return o}async blobToBase64(e){return new Promise((o,a)=>{const r=new FileReader;r.onload=()=>o(r.result),r.onerror=a,r.readAsDataURL(e)})}async repairAllAudioUrls(){console.log("ğŸ”§ CentralAudioManager: Repairing all audio URLs...");try{const e=window.database||{};if(!e.tracks)return console.log("âŒ CentralAudioManager: No tracks found in database"),0;let o=0;for(const a of e.tracks)if(a.url&&a.url.startsWith("blob:")){console.log("ğŸ”§ CentralAudioManager: Repairing track:",a.id);const r=await this.loadAudioForPlayback(a);r?(a.url=r,o++,console.log("âœ… CentralAudioManager: Track repaired:",a.id)):console.log("âŒ CentralAudioManager: Could not repair track:",a.id)}return console.log(`âœ… CentralAudioManager: Repaired ${o} audio URLs`),o}catch(e){return console.error("âŒ CentralAudioManager: Error repairing audio URLs:",e),0}}getDebugInfo(){return{isInitialized:this.isInitialized,persistenceManager:{type:"audioPersistenceManager"},availableAudioIds:[]}}}const c=new A;typeof window<"u"&&(window.centralAudioManager=c,window.repairAllAudioUrls=()=>c.repairAllAudioUrls(),window.getCentralAudioDebugInfo=()=>c.getDebugInfo());export{c as centralAudioManager};
