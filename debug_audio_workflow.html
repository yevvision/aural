<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Workflow Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e55a2b;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
        .warning { background: #ff9800; }
        .track-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .track-info {
            margin-bottom: 10px;
        }
        .track-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .play-btn { background: #4CAF50; }
        .test-btn { background: #2196F3; }
        .debug-btn { background: #9C27B0; }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .debug-info {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .step {
            background: #444;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ff6b35;
        }
        .step.completed {
            border-left-color: #4CAF50;
        }
        .step.error {
            border-left-color: #f44336;
        }
        .url-preview {
            background: #000;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 10px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üéµ Audio Workflow Debug</h1>
    
    <div class="test-section">
        <h2>üìã Workflow Steps</h2>
        <div id="workflow-steps">
            <div class="step" id="step1">1. Audio-Datei ausw√§hlen</div>
            <div class="step" id="step2">2. Base64-URL erstellen</div>
            <div class="step" id="step3">3. Track-Objekt erstellen</div>
            <div class="step" id="step4">4. Track in localStorage speichern</div>
            <div class="step" id="step5">5. Track aus localStorage laden</div>
            <div class="step" id="step6">6. Audio-Wiedergabe testen</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üéµ Audio Upload</h2>
        <input type="file" id="audioFile" accept="audio/*" />
        <button onclick="step1_selectAudio()">1. Audio ausw√§hlen</button>
        <div id="step1-status" class="status info">W√§hlen Sie eine Audio-Datei...</div>
        <div id="audio-preview"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Base64 Konvertierung</h2>
        <button onclick="step2_convertToBase64()">2. Zu Base64 konvertieren</button>
        <div id="step2-status" class="status info">Bereit...</div>
        <div id="base64-preview"></div>
    </div>

    <div class="test-section">
        <h2>üì¶ Track-Objekt</h2>
        <button onclick="step3_createTrack()">3. Track-Objekt erstellen</button>
        <div id="step3-status" class="status info">Bereit...</div>
        <div id="track-preview"></div>
    </div>

    <div class="test-section">
        <h2>üíæ Speichern & Laden</h2>
        <button onclick="step4_saveTrack()">4. Track speichern</button>
        <button onclick="step5_loadTrack()">5. Track laden</button>
        <div id="step4-status" class="status info">Bereit...</div>
        <div id="storage-preview"></div>
    </div>

    <div class="test-section">
        <h2>‚ñ∂Ô∏è Audio-Wiedergabe</h2>
        <button onclick="step6_testPlayback()">6. Audio-Wiedergabe testen</button>
        <div id="step6-status" class="status info">Bereit...</div>
        <div id="playback-preview"></div>
    </div>

    <div class="test-section">
        <h2>üîç Debug Information</h2>
        <button onclick="showDebugInfo()">Debug Info anzeigen</button>
        <button onclick="clearAllData()">Alle Daten l√∂schen</button>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        let currentAudioFile = null;
        let base64Url = null;
        let trackObject = null;
        let loadedTrack = null;

        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
        }

        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#ffd93d';
            debugInfo.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function step1_selectAudio() {
            const fileInput = document.getElementById('audioFile');
            const status = document.getElementById('step1-status');
            const preview = document.getElementById('audio-preview');
            
            if (!fileInput.files[0]) {
                status.textContent = '‚ùå Bitte w√§hlen Sie eine Audio-Datei aus';
                status.className = 'status error';
                return;
            }

            try {
                currentAudioFile = fileInput.files[0];
                const blobUrl = URL.createObjectURL(currentAudioFile);
                
                status.textContent = `‚úÖ Audio geladen: ${currentAudioFile.name} (${(currentAudioFile.size / 1024).toFixed(1)} KB)`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>${currentAudioFile.name}</h4>
                        <p><strong>Typ:</strong> ${currentAudioFile.type}</p>
                        <p><strong>Gr√∂√üe:</strong> ${(currentAudioFile.size / 1024).toFixed(1)} KB</p>
                        <audio controls>
                            <source src="${blobUrl}" type="${currentAudioFile.type}">
                        </audio>
                    </div>
                `;

                updateStep('step1', 'completed');
                log(`Audio selected: ${currentAudioFile.name}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                updateStep('step1', 'error');
                log(`Audio selection error: ${error.message}`, 'error');
            }
        }

        async function step2_convertToBase64() {
            const status = document.getElementById('step2-status');
            const preview = document.getElementById('base64-preview');
            
            if (!currentAudioFile) {
                status.textContent = '‚ùå Bitte w√§hlen Sie zuerst eine Audio-Datei aus';
                status.className = 'status error';
                updateStep('step2', 'error');
                return;
            }

            try {
                status.textContent = 'üîÑ Konvertierung l√§uft...';
                status.className = 'status info';

                const reader = new FileReader();
                base64Url = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(currentAudioFile);
                });

                status.textContent = `‚úÖ Base64-URL erstellt (${(base64Url.length / 1024).toFixed(1)} KB)`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Base64-URL Details</h4>
                        <p><strong>L√§nge:</strong> ${base64Url.length} Zeichen</p>
                        <p><strong>Gr√∂√üe:</strong> ${(base64Url.length / 1024).toFixed(1)} KB</p>
                        <p><strong>Startet mit:</strong> ${base64Url.substring(0, 50)}...</p>
                        <div class="url-preview">${base64Url.substring(0, 200)}...</div>
                        <audio controls>
                            <source src="${base64Url}" type="${currentAudioFile.type}">
                        </audio>
                    </div>
                `;

                updateStep('step2', 'completed');
                log(`Base64 conversion completed, length: ${base64Url.length}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                updateStep('step2', 'error');
                log(`Base64 conversion error: ${error.message}`, 'error');
            }
        }

        function step3_createTrack() {
            const status = document.getElementById('step3-status');
            const preview = document.getElementById('track-preview');
            
            if (!base64Url) {
                status.textContent = '‚ùå Bitte konvertieren Sie zuerst die Audio-Datei zu Base64';
                status.className = 'status error';
                updateStep('step3', 'error');
                return;
            }

            try {
                const trackId = 'debug_' + Date.now();
                
                trackObject = {
                    id: trackId,
                    title: 'Debug Track ' + trackId,
                    description: 'Debug Description',
                    url: base64Url,
                    duration: 0, // Wird sp√§ter gesetzt
                    user: {
                        id: 'debug-user',
                        username: 'Debug User',
                        email: 'debug@example.com',
                        avatar: '',
                        createdAt: new Date(),
                        isAdmin: false
                    },
                    likes: 0,
                    isLiked: false,
                    isBookmarked: false,
                    createdAt: new Date(),
                    tags: [],
                    gender: undefined,
                    filename: currentAudioFile.name,
                    fileSize: currentAudioFile.size,
                    format: currentAudioFile.type
                };

                status.textContent = `‚úÖ Track-Objekt erstellt: ${trackObject.title}`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Track-Objekt Details</h4>
                        <p><strong>ID:</strong> ${trackObject.id}</p>
                        <p><strong>Titel:</strong> ${trackObject.title}</p>
                        <p><strong>Datei:</strong> ${trackObject.filename}</p>
                        <p><strong>Gr√∂√üe:</strong> ${(trackObject.fileSize / 1024).toFixed(1)} KB</p>
                        <p><strong>Format:</strong> ${trackObject.format}</p>
                        <p><strong>URL-Typ:</strong> ${trackObject.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        <p><strong>URL-L√§nge:</strong> ${trackObject.url.length} Zeichen</p>
                    </div>
                `;

                updateStep('step3', 'completed');
                log(`Track object created: ${trackObject.title}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                updateStep('step3', 'error');
                log(`Track creation error: ${error.message}`, 'error');
            }
        }

        function step4_saveTrack() {
            const status = document.getElementById('step4-status');
            const preview = document.getElementById('storage-preview');
            
            if (!trackObject) {
                status.textContent = '‚ùå Bitte erstellen Sie zuerst ein Track-Objekt';
                status.className = 'status error';
                updateStep('step4', 'error');
                return;
            }

            try {
                // Speichere in localStorage
                const existingTracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
                existingTracks.push(trackObject);
                localStorage.setItem('aural_tracks', JSON.stringify(existingTracks));

                status.textContent = `‚úÖ Track gespeichert (${existingTracks.length} Tracks total)`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Speicher-Status</h4>
                        <p><strong>Gespeichert in:</strong> localStorage</p>
                        <p><strong>Schl√ºssel:</strong> aural_tracks</p>
                        <p><strong>Anzahl Tracks:</strong> ${existingTracks.length}</p>
                        <p><strong>Track-ID:</strong> ${trackObject.id}</p>
                    </div>
                `;

                updateStep('step4', 'completed');
                log(`Track saved to localStorage, total tracks: ${existingTracks.length}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                updateStep('step4', 'error');
                log(`Save error: ${error.message}`, 'error');
            }
        }

        function step5_loadTrack() {
            const status = document.getElementById('step4-status');
            const preview = document.getElementById('storage-preview');
            
            try {
                const stored = localStorage.getItem('aural_tracks');
                const tracks = stored ? JSON.parse(stored) : [];
                const lastTrack = tracks[tracks.length - 1];
                
                if (lastTrack) {
                    loadedTrack = lastTrack;
                    status.textContent = `‚úÖ Track geladen: ${lastTrack.title}`;
                    status.className = 'status success';
                    
                    preview.innerHTML += `
                        <div class="track-item">
                            <h4>Geladener Track</h4>
                            <p><strong>ID:</strong> ${lastTrack.id}</p>
                            <p><strong>Titel:</strong> ${lastTrack.title}</p>
                            <p><strong>URL-Typ:</strong> ${lastTrack.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                            <p><strong>URL-L√§nge:</strong> ${lastTrack.url.length} Zeichen</p>
                            <p><strong>Format:</strong> ${lastTrack.format}</p>
                        </div>
                    `;

                    updateStep('step5', 'completed');
                    log(`Track loaded: ${lastTrack.title}`, 'success');
                } else {
                    status.textContent = '‚ùå Kein Track gefunden';
                    status.className = 'status error';
                    updateStep('step5', 'error');
                    log('No track found in localStorage', 'error');
                }
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                updateStep('step5', 'error');
                log(`Load error: ${error.message}`, 'error');
            }
        }

        function step6_testPlayback() {
            const status = document.getElementById('step6-status');
            const preview = document.getElementById('playback-preview');
            
            if (!loadedTrack) {
                status.textContent = '‚ùå Bitte laden Sie zuerst einen Track';
                status.className = 'status error';
                updateStep('step6', 'error');
                return;
            }

            try {
                status.textContent = 'üîÑ Audio-Wiedergabe wird getestet...';
                status.className = 'status info';

                const audio = new Audio(loadedTrack.url);
                
                // Event listeners f√ºr Debugging
                audio.addEventListener('loadstart', () => {
                    log('Audio load started', 'info');
                });
                
                audio.addEventListener('loadeddata', () => {
                    log('Audio data loaded', 'success');
                });
                
                audio.addEventListener('canplay', () => {
                    log('Audio can play', 'success');
                });
                
                audio.addEventListener('play', () => {
                    log('Audio started playing', 'success');
                    status.textContent = '‚úÖ Audio spielt erfolgreich!';
                    status.className = 'status success';
                    updateStep('step6', 'completed');
                });
                
                audio.addEventListener('error', (e) => {
                    log(`Audio error: ${e}`, 'error');
                    status.textContent = '‚ùå Audio-Fehler aufgetreten';
                    status.className = 'status error';
                    updateStep('step6', 'error');
                });
                
                audio.addEventListener('pause', () => {
                    log('Audio paused', 'info');
                });
                
                audio.addEventListener('ended', () => {
                    log('Audio ended', 'info');
                });

                // Versuche abzuspielen
                audio.play().then(() => {
                    log('Audio play successful', 'success');
                }).catch(error => {
                    log(`Audio play failed: ${error.message}`, 'error');
                    status.textContent = `‚ùå Audio-Wiedergabe fehlgeschlagen: ${error.message}`;
                    status.className = 'status error';
                    updateStep('step6', 'error');
                });

                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Audio-Wiedergabe Test</h4>
                        <p><strong>Track:</strong> ${loadedTrack.title}</p>
                        <p><strong>URL-Typ:</strong> ${loadedTrack.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        <p><strong>Format:</strong> ${loadedTrack.format}</p>
                        <audio controls>
                            <source src="${loadedTrack.url}" type="${loadedTrack.format}">
                        </audio>
                    </div>
                `;

            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                updateStep('step6', 'error');
                log(`Playback test error: ${error.message}`, 'error');
            }
        }

        function showDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const tracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
            
            debugInfo.innerHTML = `
                <div style="color: #4ecdc4">=== AUDIO WORKFLOW DEBUG ===</div>
                <div>Current Audio File: ${currentAudioFile ? currentAudioFile.name : 'None'}</div>
                <div>Base64 URL: ${base64Url ? 'Created (' + base64Url.length + ' chars)' : 'None'}</div>
                <div>Track Object: ${trackObject ? trackObject.title : 'None'}</div>
                <div>Loaded Track: ${loadedTrack ? loadedTrack.title : 'None'}</div>
                <div>Stored Tracks: ${tracks.length}</div>
                <div style="color: #ffd93d">=== STORED TRACKS ===</div>
                <div>${JSON.stringify(tracks, null, 2)}</div>
            `;
        }

        function clearAllData() {
            localStorage.removeItem('aural_tracks');
            currentAudioFile = null;
            base64Url = null;
            trackObject = null;
            loadedTrack = null;
            
            // Reset steps
            for (let i = 1; i <= 6; i++) {
                updateStep(`step${i}`, '');
            }
            
            document.getElementById('workflow-steps').innerHTML = `
                <div class="step" id="step1">1. Audio-Datei ausw√§hlen</div>
                <div class="step" id="step2">2. Base64-URL erstellen</div>
                <div class="step" id="step3">3. Track-Objekt erstellen</div>
                <div class="step" id="step4">4. Track in localStorage speichern</div>
                <div class="step" id="step5">5. Track aus localStorage laden</div>
                <div class="step" id="step6">6. Audio-Wiedergabe testen</div>
            `;
            
            log('All data cleared', 'info');
        }

        // Initial load
        step5_loadTrack();
    </script>
</body>
</html>
