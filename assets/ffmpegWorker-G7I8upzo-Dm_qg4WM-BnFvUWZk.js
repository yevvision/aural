(function(){"use strict";(function(){(function(){var r;(function(a){a.LOAD="LOAD",a.EXEC="EXEC",a.FFPROBE="FFPROBE",a.WRITE_FILE="WRITE_FILE",a.READ_FILE="READ_FILE",a.DELETE_FILE="DELETE_FILE",a.RENAME="RENAME",a.CREATE_DIR="CREATE_DIR",a.LIST_DIR="LIST_DIR",a.DELETE_DIR="DELETE_DIR",a.ERROR="ERROR",a.DOWNLOAD="DOWNLOAD",a.PROGRESS="PROGRESS",a.LOG="LOG",a.MOUNT="MOUNT",a.UNMOUNT="UNMOUNT"})(r||(r={}));const w=(()=>{let a=0;return()=>a++})(),F=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),g=new Error("called FFmpeg.terminate()");class y{#t=null;#s={};#a={};#r=[];#o=[];loaded=!1;#i=()=>{this.#t&&(this.#t.onmessage=({data:{id:e,type:t,data:s}})=>{switch(t){case r.LOAD:this.loaded=!0,this.#s[e](s);break;case r.MOUNT:case r.UNMOUNT:case r.EXEC:case r.FFPROBE:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:this.#s[e](s);break;case r.LOG:this.#r.forEach(o=>o(s));break;case r.PROGRESS:this.#o.forEach(o=>o(s));break;case r.ERROR:this.#a[e](s);break}delete this.#s[e],delete this.#a[e]})};#e=({type:e,data:t},s=[],o)=>this.#t?new Promise((i,n)=>{const c=w();this.#t&&this.#t.postMessage({id:c,type:e,data:t},s),this.#s[c]=i,this.#a[c]=n,o?.addEventListener("abort",()=>{n(new DOMException(`Message # ${c} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(F);on(e,t){e==="log"?this.#r.push(t):e==="progress"&&this.#o.push(t)}off(e,t){e==="log"?this.#r=this.#r.filter(s=>s!==t):e==="progress"&&(this.#o=this.#o.filter(s=>s!==t))}load=({classWorkerURL:e,...t}={},{signal:s}={})=>(this.#t||(this.#t=e?new Worker(new URL(e,self.location.href),{type:"module"}):new Worker(new URL("/assets/worker-BAOIWoxA.js",self.location.href),{type:"module"}),this.#i()),this.#e({type:r.LOAD,data:t},void 0,s));exec=(e,t=-1,{signal:s}={})=>this.#e({type:r.EXEC,data:{args:e,timeout:t}},void 0,s);ffprobe=(e,t=-1,{signal:s}={})=>this.#e({type:r.FFPROBE,data:{args:e,timeout:t}},void 0,s);terminate=()=>{const e=Object.keys(this.#a);for(const t of e)this.#a[t](g),delete this.#a[t],delete this.#s[t];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(e,t,{signal:s}={})=>{const o=[];return t instanceof Uint8Array&&o.push(t.buffer),this.#e({type:r.WRITE_FILE,data:{path:e,data:t}},o,s)};mount=(e,t,s)=>{const o=[];return this.#e({type:r.MOUNT,data:{fsType:e,options:t,mountPoint:s}},o)};unmount=e=>{const t=[];return this.#e({type:r.UNMOUNT,data:{mountPoint:e}},t)};readFile=(e,t="binary",{signal:s}={})=>this.#e({type:r.READ_FILE,data:{path:e,encoding:t}},void 0,s);deleteFile=(e,{signal:t}={})=>this.#e({type:r.DELETE_FILE,data:{path:e}},void 0,t);rename=(e,t,{signal:s}={})=>this.#e({type:r.RENAME,data:{oldPath:e,newPath:t}},void 0,s);createDir=(e,{signal:t}={})=>this.#e({type:r.CREATE_DIR,data:{path:e}},void 0,t);listDir=(e,{signal:t}={})=>this.#e({type:r.LIST_DIR,data:{path:e}},void 0,t);deleteDir=(e,{signal:t}={})=>this.#e({type:r.DELETE_DIR,data:{path:e}},void 0,t)}var h;(function(a){a.MEMFS="MEMFS",a.NODEFS="NODEFS",a.NODERAWFS="NODERAWFS",a.IDBFS="IDBFS",a.WORKERFS="WORKERFS",a.PROXYFS="PROXYFS"})(h||(h={}));const D=new Error("failed to get response body reader"),L=new Error("failed to complete download"),O="Content-Length",I=async(a,e)=>{const t=await fetch(a);let s;try{const o=parseInt(t.headers.get(O)||"-1"),i=t.body?.getReader();if(!i)throw D;const n=[];let c=0;for(;;){const{done:E,value:d}=await i.read(),f=d?d.length:0;if(E){if(o!=-1&&o!==c)throw L;e&&e({url:a,total:o,received:c,delta:f,done:E});break}n.push(d),c+=f,e&&e({url:a,total:o,received:c,delta:f,done:E})}const R=new Uint8Array(c);let u=0;for(const E of n)R.set(E,u),u+=E.length;s=R.buffer}catch(o){console.log("failed to send download progress event: ",o),s=await t.arrayBuffer()}return s},p=async(a,e,t=!1,s)=>{const o=t?await I(a,s):await(await fetch(a)).arrayBuffer(),i=new Blob([o],{type:e});return URL.createObjectURL(i)};let l=null;async function m(){if(l)return l;l=new y;const a="https://unpkg.com/@ffmpeg/core@0.12.4/dist";try{await l.load({coreURL:await p(`${a}/ffmpeg-core.js`,"text/javascript"),wasmURL:await p(`${a}/ffmpeg-core.wasm`,"application/wasm")}),console.log("FFmpeg loaded successfully")}catch(e){throw console.error("Failed to load FFmpeg:",e),new Error("FFmpeg konnte nicht geladen werden. Verwende WAV-Export.")}return l}self.onmessage=async a=>{const{type:e,wavArrayBuffer:t,fmt:s,kbps:o}=a.data||{};if(e==="encode")try{const i=await m();if(await i.writeFile("in.wav",new Uint8Array(t)),s==="mp3"){await i.exec(["-i","in.wav","-b:a",`${o}k`,"out.mp3"]);const n=await i.readFile("out.mp3");self.postMessage({type:"done",data:n.buffer},[n.buffer]);return}if(s==="aac"){await i.exec(["-i","in.wav","-c:a","aac","-b:a",`${o}k`,"out.aac"]);const n=await i.readFile("out.aac");self.postMessage({type:"done",data:n.buffer},[n.buffer]);return}self.postMessage({type:"error",error:"Unsupported format"})}catch(i){self.postMessage({type:"error",error:String(i)})}}})()})()})();
