<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Workflow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e55a2b;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
        .track-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
        }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .debug-info {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üéµ Complete Workflow Test</h1>
    
    <div class="test-section">
        <h2>1. Audio Upload & Pending</h2>
        <input type="file" id="audioFile" accept="audio/*" />
        <button onclick="createPendingUpload()">Upload erstellen</button>
        <div id="upload-status" class="status info">W√§hlen Sie eine Audio-Datei...</div>
        <div id="upload-preview"></div>
    </div>

    <div class="test-section">
        <h2>2. Admin Approval</h2>
        <button onclick="approveUpload()">Upload freigeben</button>
        <div id="approval-status" class="status info">Bereit...</div>
        <div id="approval-preview"></div>
    </div>

    <div class="test-section">
        <h2>3. Main Page Display</h2>
        <button onclick="loadMainPageTracks()">Hauptseite laden</button>
        <div id="main-status" class="status info">Bereit...</div>
        <div id="main-preview"></div>
    </div>

    <div class="test-section">
        <h2>4. Audio Playback Test</h2>
        <button onclick="testAudioPlayback()">Audio testen</button>
        <div id="audio-status" class="status info">Bereit...</div>
        <div id="audio-preview"></div>
    </div>

    <div class="test-section">
        <h2>5. Debug Information</h2>
        <button onclick="showDebugInfo()">Debug Info anzeigen</button>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        let currentAudioFile = null;
        let pendingUpload = null;
        let approvedTrack = null;

        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#ffd93d';
            debugInfo.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function createPendingUpload() {
            const fileInput = document.getElementById('audioFile');
            const status = document.getElementById('upload-status');
            const preview = document.getElementById('upload-preview');
            
            if (!fileInput.files[0]) {
                status.textContent = '‚ùå Bitte w√§hlen Sie eine Audio-Datei aus';
                status.className = 'status error';
                return;
            }

            try {
                currentAudioFile = fileInput.files[0];
                const blobUrl = URL.createObjectURL(currentAudioFile);
                
                const uploadId = 'test_' + Date.now();
                pendingUpload = {
                    uploadId,
                    filename: currentAudioFile.name,
                    originalName: currentAudioFile.name,
                    size: currentAudioFile.size,
                    mimeType: currentAudioFile.type,
                    url: blobUrl,
                    title: 'Test Upload ' + uploadId,
                    description: 'Test Description',
                    uploadedAt: new Date().toISOString(),
                    status: 'pending_review',
                    reason: 'Audio zu kurz (< 15s)',
                    userId: 'test-user',
                    username: 'Test User',
                    duration: 5
                };

                // Speichere in localStorage
                const existingUploads = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
                existingUploads[uploadId] = pendingUpload;
                localStorage.setItem('aural_pending_uploads', JSON.stringify(existingUploads));

                status.textContent = `‚úÖ Pending Upload erstellt: ${pendingUpload.title}`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>${pendingUpload.title}</h4>
                        <p><strong>Datei:</strong> ${pendingUpload.filename}</p>
                        <p><strong>Gr√∂√üe:</strong> ${(pendingUpload.size / 1024).toFixed(1)} KB</p>
                        <p><strong>Grund:</strong> ${pendingUpload.reason}</p>
                        <audio controls>
                            <source src="${pendingUpload.url}" type="${pendingUpload.mimeType}">
                        </audio>
                    </div>
                `;

                log(`Pending upload created: ${uploadId}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Upload creation error: ${error.message}`, 'error');
            }
        }

        async function approveUpload() {
            const status = document.getElementById('approval-status');
            const preview = document.getElementById('approval-preview');
            
            if (!pendingUpload) {
                status.textContent = '‚ùå Kein Pending Upload vorhanden';
                status.className = 'status error';
                return;
            }

            try {
                status.textContent = 'üîÑ Freigabe l√§uft...';
                status.className = 'status info';

                // Konvertiere Blob-URL zu Base64
                let audioDataUrl = pendingUpload.url;
                if (pendingUpload.url && pendingUpload.url.startsWith('blob:')) {
                    const response = await fetch(pendingUpload.url);
                    const blob = await response.blob();
                    audioDataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                }

                // Erstelle freigegebenen Track
                approvedTrack = {
                    id: pendingUpload.uploadId,
                    title: pendingUpload.title,
                    description: pendingUpload.description,
                    url: audioDataUrl,
                    duration: pendingUpload.duration || 0,
                    user: {
                        id: pendingUpload.userId,
                        username: pendingUpload.username,
                        email: '',
                        avatar: '',
                        createdAt: new Date(),
                        isAdmin: false
                    },
                    likes: 0,
                    isLiked: false,
                    isBookmarked: false,
                    createdAt: new Date(pendingUpload.uploadedAt),
                    tags: [],
                    gender: undefined,
                    filename: pendingUpload.filename,
                    fileSize: pendingUpload.size,
                    format: pendingUpload.mimeType
                };

                // Speichere in localStorage
                const existingTracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
                existingTracks.push(approvedTrack);
                localStorage.setItem('aural_tracks', JSON.stringify(existingTracks));

                // Entferne aus Pending
                const uploads = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
                delete uploads[pendingUpload.uploadId];
                localStorage.setItem('aural_pending_uploads', JSON.stringify(uploads));

                // Trigger Event
                window.dispatchEvent(new CustomEvent('trackApproved', { 
                    detail: { trackId: approvedTrack.id, track: approvedTrack } 
                }));

                status.textContent = '‚úÖ Upload erfolgreich freigegeben!';
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Freigegebener Track</h4>
                        <p><strong>Titel:</strong> ${approvedTrack.title}</p>
                        <p><strong>URL-Typ:</strong> ${approvedTrack.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        <p><strong>URL-L√§nge:</strong> ${approvedTrack.url.length} Zeichen</p>
                    </div>
                `;

                log(`Upload approved: ${approvedTrack.title}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Approval error: ${error.message}`, 'error');
            }
        }

        function loadMainPageTracks() {
            const status = document.getElementById('main-status');
            const preview = document.getElementById('main-preview');
            
            try {
                const tracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
                
                status.textContent = `‚úÖ ${tracks.length} Tracks auf Hauptseite geladen`;
                status.className = 'status success';
                
                preview.innerHTML = tracks.map(track => `
                    <div class="track-item">
                        <h4>${track.title}</h4>
                        <p><strong>User:</strong> ${track.user?.username || 'Unknown'}</p>
                        <p><strong>URL-Typ:</strong> ${track.url ? (track.url.startsWith('data:') ? 'Base64' : 'Blob') : 'No URL'}</p>
                        <p><strong>Erstellt:</strong> ${new Date(track.createdAt).toLocaleString()}</p>
                    </div>
                `).join('');

                log(`Main page loaded ${tracks.length} tracks`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Main page load error: ${error.message}`, 'error');
            }
        }

        function testAudioPlayback() {
            const status = document.getElementById('audio-status');
            const preview = document.getElementById('audio-preview');
            
            if (!approvedTrack) {
                status.textContent = '‚ùå Kein freigegebener Track vorhanden';
                status.className = 'status error';
                return;
            }

            try {
                status.textContent = 'üîÑ Audio-Wiedergabe wird getestet...';
                status.className = 'status info';

                const audio = new Audio(approvedTrack.url);
                
                audio.addEventListener('play', () => {
                    status.textContent = '‚úÖ Audio spielt erfolgreich!';
                    status.className = 'status success';
                    log('Audio playback successful', 'success');
                });
                
                audio.addEventListener('error', (e) => {
                    status.textContent = '‚ùå Audio-Fehler aufgetreten';
                    status.className = 'status error';
                    log(`Audio error: ${e}`, 'error');
                });

                audio.play().catch(error => {
                    status.textContent = `‚ùå Audio-Wiedergabe fehlgeschlagen: ${error.message}`;
                    status.className = 'status error';
                    log(`Audio play failed: ${error.message}`, 'error');
                });

                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Audio-Wiedergabe Test</h4>
                        <p><strong>Track:</strong> ${approvedTrack.title}</p>
                        <p><strong>URL-Typ:</strong> ${approvedTrack.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        <audio controls>
                            <source src="${approvedTrack.url}" type="${approvedTrack.format}">
                        </audio>
                    </div>
                `;

            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Audio test error: ${error.message}`, 'error');
            }
        }

        function showDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const pendingUploads = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
            const tracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
            
            debugInfo.innerHTML = `
                <div style="color: #4ecdc4">=== COMPLETE WORKFLOW DEBUG ===</div>
                <div>Current Audio File: ${currentAudioFile ? currentAudioFile.name : 'None'}</div>
                <div>Pending Upload: ${pendingUpload ? pendingUpload.title : 'None'}</div>
                <div>Approved Track: ${approvedTrack ? approvedTrack.title : 'None'}</div>
                <div>Pending Uploads: ${Object.keys(pendingUploads).length}</div>
                <div>Approved Tracks: ${tracks.length}</div>
                <div style="color: #ffd93d">=== PENDING UPLOADS ===</div>
                <div>${JSON.stringify(pendingUploads, null, 2)}</div>
                <div style="color: #ffd93d">=== APPROVED TRACKS ===</div>
                <div>${JSON.stringify(tracks, null, 2)}</div>
            `;
        }

        // Event Listener f√ºr Track Approval
        window.addEventListener('trackApproved', (event) => {
            log('Track approved event received: ' + event.detail.trackId, 'success');
            loadMainPageTracks(); // Automatisch Hauptseite aktualisieren
        });

        // Initial load
        loadMainPageTracks();
    </script>
</body>
</html>
