<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Audio Playback</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        pre { background: #2d2d2d; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .track { margin: 10px 0; padding: 10px; background: #333; border-radius: 4px; }
        audio { width: 100%; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🔊 Debug: Audio Playback</h1>
    
    <div class="section">
        <h2>🧪 Test: Audio-URL Konvertierung</h2>
        <button class="button" onclick="testAudioConversion()">🔄 Audio-Konvertierung testen</button>
        <div id="conversionResult"></div>
    </div>
    
    <div class="section">
        <h2>🎵 Test: Audio Playback</h2>
        <button class="button" onclick="testAudioPlayback()">▶️ Audio Playback testen</button>
        <div id="playbackResult"></div>
    </div>
    
    <div class="section">
        <h2>📊 Aktuelle Tracks in der DB</h2>
        <button class="button" onclick="showTracksInDB()">🔍 Tracks in DB anzeigen</button>
        <div id="tracksResult"></div>
    </div>
    
    <div class="section">
        <h2>🔧 Test: Track hinzufügen und abspielen</h2>
        <button class="button" onclick="addAndPlayTrack()">➕ Track hinzufügen und abspielen</button>
        <div id="addPlayResult"></div>
    </div>

    <script>
        function testAudioConversion() {
            console.log('🧪 Teste Audio-Konvertierung...');
            
            // Erstelle eine Test-Audio-Datei
            const audioBlob = new Blob(['fake audio data'], { type: 'audio/mpeg' });
            const blobUrl = URL.createObjectURL(audioBlob);
            
            console.log('📤 Blob-URL erstellt:', blobUrl);
            
            // Konvertiere zu Base64
            fetch(blobUrl)
                .then(response => response.blob())
                .then(blob => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                })
                .then(base64Url => {
                    console.log('✅ Base64-URL erstellt:', base64Url.substring(0, 100) + '...');
                    
                    document.getElementById('conversionResult').innerHTML = `
                        <div class="success">✅ Audio-Konvertierung erfolgreich</div>
                        <p><strong>Blob-URL:</strong> ${blobUrl}</p>
                        <p><strong>Base64-URL (erste 100 Zeichen):</strong> ${base64Url.substring(0, 100)}...</p>
                        <p><strong>Base64-URL Länge:</strong> ${base64Url.length}</p>
                        <p><strong>Base64-URL startet mit data:</strong> ${base64Url.startsWith('data:') ? '✅' : '❌'}</p>
                    `;
                })
                .catch(error => {
                    console.error('❌ Fehler bei der Konvertierung:', error);
                    document.getElementById('conversionResult').innerHTML = `
                        <div class="error">❌ Fehler bei der Konvertierung: ${error.message}</div>
                    `;
                });
        }

        function testAudioPlayback() {
            console.log('🎵 Teste Audio Playback...');
            
            // Erstelle eine Test-Audio-Datei (simuliert)
            const audioBlob = new Blob(['fake audio data'], { type: 'audio/mpeg' });
            const blobUrl = URL.createObjectURL(audioBlob);
            
            // Konvertiere zu Base64
            fetch(blobUrl)
                .then(response => response.blob())
                .then(blob => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                })
                .then(base64Url => {
                    console.log('🎵 Teste Playback mit Base64-URL...');
                    
                    const audio = new Audio();
                    audio.src = base64Url;
                    
                    audio.addEventListener('loadstart', () => {
                        console.log('🎵 Audio loadstart');
                    });
                    
                    audio.addEventListener('loadedmetadata', () => {
                        console.log('🎵 Audio loadedmetadata');
                    });
                    
                    audio.addEventListener('canplay', () => {
                        console.log('🎵 Audio canplay');
                    });
                    
                    audio.addEventListener('error', (e) => {
                        console.error('🎵 Audio error:', e);
                        document.getElementById('playbackResult').innerHTML = `
                            <div class="error">❌ Audio Playback Fehler: ${e.type}</div>
                            <p><strong>Error Code:</strong> ${audio.error?.code}</p>
                            <p><strong>Error Message:</strong> ${audio.error?.message}</p>
                        `;
                    });
                    
                    audio.addEventListener('loadeddata', () => {
                        console.log('🎵 Audio loadeddata - Playback sollte funktionieren');
                        document.getElementById('playbackResult').innerHTML = `
                            <div class="success">✅ Audio Playback Test erfolgreich</div>
                            <p><strong>Base64-URL Länge:</strong> ${base64Url.length}</p>
                            <p><strong>Audio Duration:</strong> ${audio.duration || 'Unbekannt'}</p>
                            <audio controls src="${base64Url}"></audio>
                        `;
                    });
                    
                    audio.load();
                })
                .catch(error => {
                    console.error('❌ Fehler beim Audio Playback Test:', error);
                    document.getElementById('playbackResult').innerHTML = `
                        <div class="error">❌ Fehler beim Audio Playback Test: ${error.message}</div>
                    `;
                });
        }

        function showTracksInDB() {
            console.log('📊 Zeige Tracks in der DB...');
            
            const centralDBData = JSON.parse(localStorage.getItem('aural-central-database') || '{}');
            const tracks = Array.isArray(centralDBData.tracks) ? centralDBData.tracks : [];
            
            console.log(`📊 Gefunden: ${tracks.length} Tracks in der DB`);
            
            let html = `
                <div class="info">
                    <h3>📊 Tracks in der zentralen DB: ${tracks.length}</h3>
                </div>
            `;
            
            if (tracks.length > 0) {
                tracks.forEach((track, index) => {
                    const isRecent = new Date(track.createdAt) > new Date(Date.now() - 14 * 24 * 60 * 60 * 1000);
                    html += `
                        <div class="track">
                            <h4>Track ${index + 1}: ${track.title}</h4>
                            <p><strong>ID:</strong> ${track.id}</p>
                            <p><strong>CreatedAt:</strong> ${track.createdAt}</p>
                            <p><strong>Is Recent (2 weeks):</strong> ${isRecent ? '✅' : '❌'}</p>
                            <p><strong>URL Type:</strong> ${track.url ? (track.url.startsWith('data:') ? 'Base64' : 'Blob') : 'No URL'}</p>
                            <p><strong>URL Length:</strong> ${track.url ? track.url.length : 'No URL'}</p>
                            <p><strong>URL (erste 100 Zeichen):</strong> ${track.url ? track.url.substring(0, 100) + '...' : 'No URL'}</p>
                            ${track.url ? `<audio controls src="${track.url}" style="width: 100%; margin: 10px 0;"></audio>` : ''}
                        </div>
                    `;
                });
            } else {
                html += '<div class="warning">⚠️ Keine Tracks in der DB gefunden</div>';
            }
            
            document.getElementById('tracksResult').innerHTML = html;
        }

        function addAndPlayTrack() {
            console.log('➕ Füge Track hinzu und teste Playback...');
            
            // Erstelle eine Test-Audio-Datei
            const audioBlob = new Blob(['fake audio data'], { type: 'audio/mpeg' });
            const blobUrl = URL.createObjectURL(audioBlob);
            
            // Konvertiere zu Base64
            fetch(blobUrl)
                .then(response => response.blob())
                .then(blob => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                })
                .then(base64Url => {
                    // Erstelle Test-Track
                    const testTrack = {
                        id: 'test_audio_' + Date.now(),
                        title: 'Test Audio ' + new Date().toLocaleTimeString(),
                        description: 'Test-Beschreibung',
                        url: base64Url,
                        duration: 30,
                        user: {
                            id: 'user-1',
                            username: 'TestUser',
                            email: '',
                            avatar: '',
                            createdAt: new Date(),
                            isAdmin: false
                        },
                        likes: 0,
                        isLiked: false,
                        isBookmarked: false,
                        createdAt: new Date(),
                        tags: ['test'],
                        gender: 'couples',
                        filename: 'test.mp3',
                        fileSize: 1024,
                        format: 'audio/mpeg'
                    };
                    
                    // Speichere in zentraler DB
                    const centralDBData = JSON.parse(localStorage.getItem('aural-central-database') || '{}');
                    if (!Array.isArray(centralDBData.tracks)) {
                        centralDBData.tracks = [];
                    }
                    centralDBData.tracks.push(testTrack);
                    localStorage.setItem('aural-central-database', JSON.stringify(centralDBData));
                    
                    console.log('✅ Test-Track hinzugefügt:', testTrack.title);
                    
                    // Teste Playback
                    const audio = new Audio();
                    audio.src = base64Url;
                    
                    audio.addEventListener('loadeddata', () => {
                        console.log('✅ Audio Playback funktioniert');
                        document.getElementById('addPlayResult').innerHTML = `
                            <div class="success">✅ Test-Track hinzugefügt und Playback funktioniert</div>
                            <p><strong>Track:</strong> ${testTrack.title}</p>
                            <p><strong>URL Länge:</strong> ${base64Url.length}</p>
                            <audio controls src="${base64Url}" style="width: 100%; margin: 10px 0;"></audio>
                        `;
                    });
                    
                    audio.addEventListener('error', (e) => {
                        console.error('❌ Audio Playback Fehler:', e);
                        document.getElementById('addPlayResult').innerHTML = `
                            <div class="error">❌ Audio Playback Fehler: ${e.type}</div>
                            <p><strong>Error Code:</strong> ${audio.error?.code}</p>
                            <p><strong>Error Message:</strong> ${audio.error?.message}</p>
                        `;
                    });
                    
                    audio.load();
                })
                .catch(error => {
                    console.error('❌ Fehler beim Hinzufügen des Test-Tracks:', error);
                    document.getElementById('addPlayResult').innerHTML = `
                        <div class="error">❌ Fehler beim Hinzufügen des Test-Tracks: ${error.message}</div>
                    `;
                });
        }

        // Initialisierung
        console.log('🚀 Audio Playback Debug System initialisiert');
    </script>
</body>
</html>
