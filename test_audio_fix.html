<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e55a2b;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
        .track-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
        }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .debug-info {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üéµ Audio Fix Test</h1>
    
    <div class="test-section">
        <h2>1. Audio-Datei ausw√§hlen</h2>
        <input type="file" id="audioFile" accept="audio/*" />
        <button onclick="selectAudio()">Audio ausw√§hlen</button>
        <div id="audio-status" class="status info">W√§hlen Sie eine Audio-Datei...</div>
        <div id="audio-preview"></div>
    </div>

    <div class="test-section">
        <h2>2. Track erstellen und speichern</h2>
        <button onclick="createAndSaveTrack()">Track erstellen & speichern</button>
        <div id="save-status" class="status info">Bereit...</div>
        <div id="track-preview"></div>
    </div>

    <div class="test-section">
        <h2>3. Track laden und abspielen</h2>
        <button onclick="loadAndPlayTrack()">Track laden & abspielen</button>
        <div id="play-status" class="status info">Bereit...</div>
        <div id="playback-preview"></div>
    </div>

    <div class="test-section">
        <h2>4. Debug Information</h2>
        <button onclick="showDebugInfo()">Debug Info anzeigen</button>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        let currentAudioFile = null;
        let trackId = null;

        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#ffd93d';
            debugInfo.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function selectAudio() {
            const fileInput = document.getElementById('audioFile');
            const status = document.getElementById('audio-status');
            const preview = document.getElementById('audio-preview');
            
            if (!fileInput.files[0]) {
                status.textContent = '‚ùå Bitte w√§hlen Sie eine Audio-Datei aus';
                status.className = 'status error';
                return;
            }

            try {
                currentAudioFile = fileInput.files[0];
                const blobUrl = URL.createObjectURL(currentAudioFile);
                
                status.textContent = `‚úÖ Audio geladen: ${currentAudioFile.name} (${(currentAudioFile.size / 1024).toFixed(1)} KB)`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>${currentAudioFile.name}</h4>
                        <p><strong>Typ:</strong> ${currentAudioFile.type}</p>
                        <p><strong>Gr√∂√üe:</strong> ${(currentAudioFile.size / 1024).toFixed(1)} KB</p>
                        <audio controls>
                            <source src="${blobUrl}" type="${currentAudioFile.type}">
                        </audio>
                    </div>
                `;

                log(`Audio selected: ${currentAudioFile.name}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Audio selection error: ${error.message}`, 'error');
            }
        }

        async function createAndSaveTrack() {
            const status = document.getElementById('save-status');
            const preview = document.getElementById('track-preview');
            
            if (!currentAudioFile) {
                status.textContent = '‚ùå Bitte w√§hlen Sie zuerst eine Audio-Datei aus';
                status.className = 'status error';
                return;
            }

            try {
                status.textContent = 'üîÑ Track wird erstellt...';
                status.className = 'status info';

                // Konvertiere zu Base64
                const base64Url = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(currentAudioFile);
                });

                // Erstelle Track-Objekt
                trackId = 'test_' + Date.now();
                const track = {
                    id: trackId,
                    title: 'Test Track ' + trackId,
                    description: 'Test Description',
                    url: base64Url,
                    duration: 0,
                    user: {
                        id: 'test-user',
                        username: 'Test User',
                        email: 'test@example.com',
                        avatar: '',
                        createdAt: new Date(),
                        isAdmin: false
                    },
                    likes: 0,
                    isLiked: false,
                    isBookmarked: false,
                    createdAt: new Date(),
                    tags: [],
                    gender: undefined,
                    filename: currentAudioFile.name,
                    fileSize: currentAudioFile.size,
                    format: currentAudioFile.type
                };

                // Speichere in localStorage
                const existingTracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
                existingTracks.push(track);
                localStorage.setItem('aural_tracks', JSON.stringify(existingTracks));

                status.textContent = `‚úÖ Track erstellt und gespeichert: ${track.title}`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Gespeicherter Track</h4>
                        <p><strong>ID:</strong> ${track.id}</p>
                        <p><strong>Titel:</strong> ${track.title}</p>
                        <p><strong>URL-Typ:</strong> ${track.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        <p><strong>URL-L√§nge:</strong> ${track.url.length} Zeichen</p>
                        <p><strong>Format:</strong> ${track.format}</p>
                    </div>
                `;

                log(`Track created and saved: ${track.title}`, 'success');
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Track creation error: ${error.message}`, 'error');
            }
        }

        function loadAndPlayTrack() {
            const status = document.getElementById('play-status');
            const preview = document.getElementById('playback-preview');
            
            try {
                const stored = localStorage.getItem('aural_tracks');
                const tracks = stored ? JSON.parse(stored) : [];
                const track = tracks.find(t => t.id === trackId);
                
                if (!track) {
                    status.textContent = '‚ùå Track nicht gefunden';
                    status.className = 'status error';
                    return;
                }

                status.textContent = 'üîÑ Track wird geladen...';
                status.className = 'status info';

                // Teste Audio-Wiedergabe
                const audio = new Audio(track.url);
                
                audio.addEventListener('loadstart', () => {
                    log('Audio load started', 'info');
                });
                
                audio.addEventListener('loadeddata', () => {
                    log('Audio data loaded', 'success');
                });
                
                audio.addEventListener('canplay', () => {
                    log('Audio can play', 'success');
                });
                
                audio.addEventListener('play', () => {
                    log('Audio started playing', 'success');
                    status.textContent = '‚úÖ Audio spielt erfolgreich!';
                    status.className = 'status success';
                });
                
                audio.addEventListener('error', (e) => {
                    log(`Audio error: ${e}`, 'error');
                    status.textContent = '‚ùå Audio-Fehler aufgetreten';
                    status.className = 'status error';
                });

                // Versuche abzuspielen
                audio.play().then(() => {
                    log('Audio play successful', 'success');
                }).catch(error => {
                    log(`Audio play failed: ${error.message}`, 'error');
                    status.textContent = `‚ùå Audio-Wiedergabe fehlgeschlagen: ${error.message}`;
                    status.className = 'status error';
                });

                preview.innerHTML = `
                    <div class="track-item">
                        <h4>Audio-Wiedergabe Test</h4>
                        <p><strong>Track:</strong> ${track.title}</p>
                        <p><strong>URL-Typ:</strong> ${track.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        <p><strong>Format:</strong> ${track.format}</p>
                        <audio controls>
                            <source src="${track.url}" type="${track.format}">
                        </audio>
                    </div>
                `;

            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                log(`Load/play error: ${error.message}`, 'error');
            }
        }

        function showDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const tracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
            
            debugInfo.innerHTML = `
                <div style="color: #4ecdc4">=== AUDIO FIX DEBUG ===</div>
                <div>Current Audio File: ${currentAudioFile ? currentAudioFile.name : 'None'}</div>
                <div>Track ID: ${trackId || 'None'}</div>
                <div>Stored Tracks: ${tracks.length}</div>
                <div style="color: #ffd93d">=== STORED TRACKS ===</div>
                <div>${JSON.stringify(tracks, null, 2)}</div>
            `;
        }
    </script>
</body>
</html>
