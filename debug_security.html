<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Sicherheitssystem Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #2ecc71; }
        .error { border-left: 4px solid #e74c3c; }
        .warning { border-left: 4px solid #f39c12; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Sicherheitssystem Debug</h1>
        
        <div class="card">
            <h2>üìã Test 1: 15-Sekunden-Regel</h2>
            <p>Teste eine kurze Audio-Datei (< 15 Sekunden)</p>
            <input type="file" id="shortAudio" accept="audio/*" />
            <button class="test-button" onclick="testShortAudio()">Teste kurze Audio</button>
            <div id="shortAudioResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üîê Test 2: Proof-of-Work</h2>
            <p>Teste die Proof-of-Work Token-Generierung</p>
            <button class="test-button" onclick="testProofOfWork()">Teste Proof-of-Work</button>
            <div id="proofOfWorkResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üìä Test 3: Rate-Limits</h2>
            <p>Teste die Rate-Limit-Erkennung</p>
            <button class="test-button" onclick="testRateLimits()">Teste Rate-Limits</button>
            <div id="rateLimitResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üîÑ Test 4: Duplikat-Erkennung</h2>
            <p>Teste die Duplikat-Erkennung</p>
            <input type="file" id="duplicateAudio" accept="audio/*" />
            <button class="test-button" onclick="testDuplicateDetection()">Teste Duplikat-Erkennung</button>
            <div id="duplicateResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üìã Test 5: Admin-Warteschlange</h2>
            <p>Zeige alle pending Uploads</p>
            <button class="test-button" onclick="showPendingUploads()">Zeige Warteschlange</button>
            <div id="pendingResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Simuliere UploadSecurityManager
        class MockUploadSecurityManager {
            constructor() {
                this.limits = {
                    maxUploadsPer30Min: 3,
                    maxUploadsPerDay: 5,
                    maxAudioMinutesPerDay: 120,
                    maxDuplicateCount: 5,
                    minAudioDuration: 15
                };
                this.deviceStats = new Map();
                this.fileHashes = new Map();
            }
            
            generateDeviceId() {
                return 'device_' + Math.random().toString(36).substring(2);
            }
            
            async calculateFileHash(file) {
                const buffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
            
            async checkUploadSecurity(file, duration) {
                const deviceId = this.generateDeviceId();
                const fileHash = await this.calculateFileHash(file);
                
                // 15-Sekunden-Check
                if (duration < this.limits.minAudioDuration) {
                    return {
                        allowed: true,
                        reason: `Audio zu kurz (${duration}s < ${this.limits.minAudioDuration}s)`,
                        requiresReview: true,
                        duplicateCheck: { isDuplicate: false, duplicateCount: 0, isSuspicious: false },
                        deviceStats: { deviceId, uploads30Min: 0, uploadsToday: 0, audioMinutesToday: 0, fileHashes: [] }
                    };
                }
                
                // Rate-Limit-Check (vereinfacht)
                const deviceStats = this.deviceStats.get(deviceId) || {
                    deviceId,
                    uploads30Min: 0,
                    uploadsToday: 0,
                    audioMinutesToday: 0,
                    fileHashes: []
                };
                
                if (deviceStats.uploads30Min >= this.limits.maxUploadsPer30Min) {
                    return {
                        allowed: false,
                        reason: 'Rate limit exceeded (3 uploads per 30 min)',
                        requiresReview: true,
                        duplicateCheck: { isDuplicate: false, duplicateCount: 0, isSuspicious: false },
                        deviceStats
                    };
                }
                
                // Duplikat-Check
                const duplicateCount = (this.fileHashes.get(fileHash) || 0) + 1;
                this.fileHashes.set(fileHash, duplicateCount);
                
                if (duplicateCount >= this.limits.maxDuplicateCount) {
                    return {
                        allowed: true,
                        reason: `Duplicate file detected (${duplicateCount}x)`,
                        requiresReview: true,
                        duplicateCheck: { isDuplicate: true, duplicateCount, isSuspicious: true },
                        deviceStats
                    };
                }
                
                return {
                    allowed: true,
                    reason: undefined,
                    requiresReview: false,
                    duplicateCheck: { isDuplicate: false, duplicateCount, isSuspicious: false },
                    deviceStats
                };
            }
        }
        
        // Simuliere CapClient
        class MockCapClient {
            async generateToken(fileSize) {
                const difficulty = Math.min(4, Math.max(1, Math.floor(Math.log10(fileSize))));
                const timestamp = Date.now();
                const randomData = Math.random().toString(36).substring(2);
                const userAgent = navigator.userAgent.substring(0, 50);
                const tokenData = `${timestamp}-${fileSize}-${difficulty}-${randomData}-${userAgent}`;
                const hash = btoa(tokenData).replace(/[^a-zA-Z0-9]/g, '');
                return `pow_${difficulty}_${hash}`;
            }
        }
        
        const securityManager = new MockUploadSecurityManager();
        const capClient = new MockCapClient();
        
        async function testShortAudio() {
            const fileInput = document.getElementById('shortAudio');
            const resultDiv = document.getElementById('shortAudioResult');
            
            if (!fileInput.files[0]) {
                showResult('shortAudioResult', 'Bitte w√§hlen Sie eine Audio-Datei aus', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const duration = 10; // Simuliere 10 Sekunden
            
            showResult('shortAudioResult', 'Teste kurze Audio...', 'warning');
            
            const securityCheck = await securityManager.checkUploadSecurity(file, duration);
            
            const result = `
üìã 15-Sekunden-Regel Test:
Datei: ${file.name}
Dauer: ${duration} Sekunden
Mindestdauer: ${securityManager.limits.minAudioDuration} Sekunden

Ergebnis:
‚úÖ Erlaubt: ${securityCheck.allowed}
üìã Review erforderlich: ${securityCheck.requiresReview}
üìù Grund: ${securityCheck.reason || 'Kein Grund'}

${securityCheck.requiresReview ? 'üéØ KORREKT: Audio sollte zur Warteschlange!' : '‚ùå FEHLER: Audio sollte zur Warteschlange!'}
            `;
            
            showResult('shortAudioResult', result, securityCheck.requiresReview ? 'success' : 'error');
        }
        
        async function testProofOfWork() {
            const resultDiv = document.getElementById('proofOfWorkResult');
            
            showResult('proofOfWorkResult', 'Generiere Proof-of-Work Token...', 'warning');
            
            const fileSize = 1024 * 1024; // 1MB
            const token = await capClient.generateToken(fileSize);
            
            const result = `
üîê Proof-of-Work Test:
Dateigr√∂√üe: ${(fileSize / 1024 / 1024).toFixed(2)} MB
Token: ${token}

‚úÖ Token erfolgreich generiert!
üéØ Das System l√§uft unsichtbar - kein "Ich bin kein Roboter" Check n√∂tig!
            `;
            
            showResult('proofOfWorkResult', result, 'success');
        }
        
        async function testRateLimits() {
            const resultDiv = document.getElementById('rateLimitResult');
            
            showResult('rateLimitResult', 'Teste Rate-Limits...', 'warning');
            
            // Simuliere mehrere Uploads
            const results = [];
            for (let i = 1; i <= 5; i++) {
                const mockFile = new File(['test'], `test${i}.wav`, { type: 'audio/wav' });
                const securityCheck = await securityManager.checkUploadSecurity(mockFile, 30);
                results.push(`Upload ${i}: ${securityCheck.allowed ? '‚úÖ Erlaubt' : '‚ùå Blockiert'} - ${securityCheck.reason || 'OK'}`);
            }
            
            const result = `
üìä Rate-Limit Test:
Limits: 3 Uploads/30min, 5 Uploads/Tag, 120min Audio/Tag

Ergebnisse:
${results.join('\n')}

üéØ Das System sollte nach 3 Uploads blockieren!
            `;
            
            showResult('rateLimitResult', result, 'success');
        }
        
        async function testDuplicateDetection() {
            const fileInput = document.getElementById('duplicateAudio');
            const resultDiv = document.getElementById('duplicateResult');
            
            if (!fileInput.files[0]) {
                showResult('duplicateResult', 'Bitte w√§hlen Sie eine Audio-Datei aus', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            showResult('duplicateResult', 'Teste Duplikat-Erkennung...', 'warning');
            
            // Simuliere mehrfache Uploads derselben Datei
            const results = [];
            for (let i = 1; i <= 6; i++) {
                const securityCheck = await securityManager.checkUploadSecurity(file, 30);
                results.push(`Upload ${i}: ${securityCheck.allowed ? '‚úÖ Erlaubt' : '‚ùå Blockiert'} - ${securityCheck.reason || 'OK'}`);
            }
            
            const result = `
üîÑ Duplikat-Erkennung Test:
Datei: ${file.name}
Limit: 5 identische Uploads

Ergebnisse:
${results.join('\n')}

üéØ Das System sollte nach 5 identischen Uploads zur Review schicken!
            `;
            
            showResult('duplicateResult', result, 'success');
        }
        
        function showPendingUploads() {
            const resultDiv = document.getElementById('pendingResult');
            
            const pendingUploads = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
            const pendingList = Object.values(pendingUploads).filter(upload => upload.status === 'pending_review');
            
            let result = `üìã Admin-Warteschlange (${pendingList.length} Uploads):\n\n`;
            
            if (pendingList.length === 0) {
                result += 'Keine pending Uploads gefunden.\n\n';
                result += 'üí° Tipp: Laden Sie eine kurze Audio (< 15s) hoch, um einen Test-Upload zu erstellen!';
            } else {
                pendingList.forEach((upload, index) => {
                    result += `${index + 1}. ${upload.title}\n`;
                    result += `   Uploader: ${upload.username} (${upload.userId})\n`;
                    result += `   Grund: ${upload.reason}\n`;
                    result += `   Datum: ${new Date(upload.uploadedAt).toLocaleString()}\n\n`;
                });
            }
            
            showResult('pendingResult', result, pendingList.length > 0 ? 'success' : 'warning');
        }
        
        function showResult(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // Lade pending Uploads beim Start
        showPendingUploads();
    </script>
</body>
</html>
