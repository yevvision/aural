<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Playback Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e55a2b;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
        .warning { background: #ff9800; }
        .track-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .track-info {
            margin-bottom: 10px;
        }
        .track-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .play-btn { background: #4CAF50; }
        .approve-btn { background: #4CAF50; }
        .reject-btn { background: #f44336; }
        .test-btn { background: #2196F3; }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .audio-test {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üéµ Audio Playback Test</h1>
    
    <div class="test-section">
        <h2>1. Audio Upload Test</h2>
        <input type="file" id="audioFile" accept="audio/*" />
        <button onclick="testAudioUpload()">Audio Upload Testen</button>
        <div id="upload-status" class="status info">W√§hlen Sie eine Audio-Datei...</div>
        <div id="audio-preview"></div>
    </div>

    <div class="test-section">
        <h2>2. Blob URL vs Base64 Test</h2>
        <button onclick="testBlobVsBase64()">Blob vs Base64 vergleichen</button>
        <div id="comparison-status" class="status info">Bereit f√ºr Vergleich...</div>
        <div id="comparison-results"></div>
    </div>

    <div class="test-section">
        <h2>3. Pending Upload Simulation</h2>
        <button onclick="simulatePendingUpload()">Pending Upload simulieren</button>
        <button onclick="approveUpload()">Upload freigeben</button>
        <div id="pending-status" class="status info">Bereit...</div>
        <div id="pending-upload"></div>
    </div>

    <div class="test-section">
        <h2>4. Freigegebener Track Test</h2>
        <button onclick="loadApprovedTrack()">Freigegebenen Track laden</button>
        <button onclick="testApprovedAudio()">Audio testen</button>
        <div id="approved-status" class="status info">Bereit...</div>
        <div id="approved-track"></div>
    </div>

    <div class="test-section">
        <h2>5. Console Logs</h2>
        <div id="console-logs" style="background: #000; padding: 10px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        let currentAudioFile = null;
        let pendingUpload = null;
        let approvedTrack = null;

        // Console logging
        const originalLog = console.log;
        const originalError = console.error;
        
        function logToPage(message, type = 'log') {
            const logs = document.getElementById('console-logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : '#4ecdc4';
            logs.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPage(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToPage(args.join(' '), 'error');
        };

        function testAudioUpload() {
            const fileInput = document.getElementById('audioFile');
            const status = document.getElementById('upload-status');
            const preview = document.getElementById('audio-preview');
            
            if (!fileInput.files[0]) {
                status.textContent = '‚ùå Bitte w√§hlen Sie eine Audio-Datei aus';
                status.className = 'status error';
                return;
            }

            try {
                currentAudioFile = fileInput.files[0];
                const blobUrl = URL.createObjectURL(currentAudioFile);
                
                status.textContent = `‚úÖ Audio geladen: ${currentAudioFile.name} (${(currentAudioFile.size / 1024).toFixed(1)} KB)`;
                status.className = 'status success';
                
                preview.innerHTML = `
                    <div class="audio-test">
                        <h4>Original Audio (Blob URL):</h4>
                        <audio controls>
                            <source src="${blobUrl}" type="${currentAudioFile.type}">
                            Ihr Browser unterst√ºtzt das Audio-Element nicht.
                        </audio>
                        <p><strong>URL:</strong> ${blobUrl}</p>
                        <p><strong>Typ:</strong> ${currentAudioFile.type}</p>
                        <p><strong>Gr√∂√üe:</strong> ${(currentAudioFile.size / 1024).toFixed(1)} KB</p>
                    </div>
                `;
                
                console.log('Audio uploaded successfully:', currentAudioFile.name);
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                console.error('Upload error:', error);
            }
        }

        async function testBlobVsBase64() {
            const status = document.getElementById('comparison-status');
            const results = document.getElementById('comparison-results');
            
            if (!currentAudioFile) {
                status.textContent = '‚ùå Bitte laden Sie zuerst eine Audio-Datei';
                status.className = 'status error';
                return;
            }

            try {
                status.textContent = 'üîÑ Teste Blob URL vs Base64...';
                status.className = 'status info';

                // 1. Blob URL
                const blobUrl = URL.createObjectURL(currentAudioFile);
                console.log('Blob URL erstellt:', blobUrl);

                // 2. Base64
                const base64Url = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(currentAudioFile);
                });
                console.log('Base64 URL erstellt, L√§nge:', base64Url.length);

                results.innerHTML = `
                    <div class="audio-test">
                        <h4>Blob URL Test:</h4>
                        <audio controls>
                            <source src="${blobUrl}" type="${currentAudioFile.type}">
                        </audio>
                        <p><strong>URL:</strong> ${blobUrl}</p>
                    </div>
                    
                    <div class="audio-test">
                        <h4>Base64 URL Test:</h4>
                        <audio controls>
                            <source src="${base64Url}" type="${currentAudioFile.type}">
                        </audio>
                        <p><strong>URL L√§nge:</strong> ${base64Url.length} Zeichen</p>
                        <p><strong>URL (erste 100 Zeichen):</strong> ${base64Url.substring(0, 100)}...</p>
                    </div>
                `;

                status.textContent = '‚úÖ Vergleich abgeschlossen - beide sollten funktionieren';
                status.className = 'status success';

                // Cleanup nach 30 Sekunden
                setTimeout(() => {
                    URL.revokeObjectURL(blobUrl);
                    console.log('Blob URL cleaned up');
                }, 30000);

            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                console.error('Comparison error:', error);
            }
        }

        function simulatePendingUpload() {
            const status = document.getElementById('pending-status');
            const uploadDiv = document.getElementById('pending-upload');
            
            if (!currentAudioFile) {
                status.textContent = '‚ùå Bitte laden Sie zuerst eine Audio-Datei';
                status.className = 'status error';
                return;
            }

            try {
                const uploadId = 'test_' + Date.now();
                const blobUrl = URL.createObjectURL(currentAudioFile);
                
                pendingUpload = {
                    uploadId,
                    filename: currentAudioFile.name,
                    originalName: currentAudioFile.name,
                    size: currentAudioFile.size,
                    mimeType: currentAudioFile.type,
                    url: blobUrl,
                    title: 'Test Upload ' + uploadId,
                    description: 'Test Description',
                    uploadedAt: new Date().toISOString(),
                    status: 'pending_review',
                    reason: 'Audio zu kurz (< 15s)',
                    userId: 'test-user',
                    username: 'Test User',
                    duration: 5
                };

                status.textContent = `‚úÖ Pending Upload erstellt: ${currentAudioFile.name}`;
                status.className = 'status success';
                
                uploadDiv.innerHTML = `
                    <div class="track-item">
                        <div class="track-info">
                            <h4>${pendingUpload.title}</h4>
                            <p><strong>Datei:</strong> ${pendingUpload.filename}</p>
                            <p><strong>Gr√∂√üe:</strong> ${(pendingUpload.size / 1024).toFixed(1)} KB</p>
                            <p><strong>Grund:</strong> ${pendingUpload.reason}</p>
                        </div>
                        <div class="track-actions">
                            <button class="play-btn" onclick="playPendingAudio()">‚ñ∂Ô∏è Abspielen</button>
                            <button class="approve-btn" onclick="approveUpload()">‚úÖ Freigeben</button>
                        </div>
                        <div class="audio-test">
                            <h5>Audio Preview:</h5>
                            <audio controls>
                                <source src="${pendingUpload.url}" type="${pendingUpload.mimeType}">
                            </audio>
                        </div>
                    </div>
                `;

                console.log('Pending upload created:', pendingUpload);
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                console.error('Simulation error:', error);
            }
        }

        function playPendingAudio() {
            if (pendingUpload && pendingUpload.url) {
                const audio = new Audio(pendingUpload.url);
                audio.play().catch(error => {
                    console.error('Audio play failed:', error);
                });
            }
        }

        async function approveUpload() {
            const status = document.getElementById('pending-status');
            const approvedStatus = document.getElementById('approved-status');
            
            if (!pendingUpload) {
                status.textContent = '‚ùå Kein Pending Upload vorhanden';
                status.className = 'status error';
                return;
            }

            try {
                status.textContent = 'üîÑ Freigabe l√§uft...';
                status.className = 'status info';

                // Konvertiere Blob-URL zu Base64
                let audioDataUrl = pendingUpload.url;
                if (pendingUpload.url && pendingUpload.url.startsWith('blob:')) {
                    console.log('Konvertiere Blob-URL zu Base64...');
                    const response = await fetch(pendingUpload.url);
                    const blob = await response.blob();
                    audioDataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                    console.log('‚úÖ Audio-Daten zu Base64 konvertiert, L√§nge:', audioDataUrl.length);
                }

                // Erstelle freigegebenen Track
                approvedTrack = {
                    id: pendingUpload.uploadId,
                    title: pendingUpload.title,
                    description: pendingUpload.description,
                    url: audioDataUrl, // Base64-URL
                    duration: pendingUpload.duration || 0,
                    user: {
                        id: pendingUpload.userId,
                        username: pendingUpload.username,
                        email: '',
                        avatar: '',
                        createdAt: new Date(),
                        isAdmin: false
                    },
                    likes: 0,
                    isLiked: false,
                    isBookmarked: false,
                    createdAt: new Date(pendingUpload.uploadedAt),
                    tags: [],
                    gender: undefined,
                    filename: pendingUpload.filename,
                    fileSize: pendingUpload.size,
                    format: pendingUpload.mimeType
                };

                // Speichere in localStorage
                const existingTracks = JSON.parse(localStorage.getItem('aural_tracks') || '[]');
                existingTracks.push(approvedTrack);
                localStorage.setItem('aural_tracks', JSON.stringify(existingTracks));

                status.textContent = '‚úÖ Upload erfolgreich freigegeben!';
                status.className = 'status success';
                
                approvedStatus.textContent = '‚úÖ Track ist bereit zum Testen';
                approvedStatus.className = 'status success';

                console.log('Upload approved successfully:', approvedTrack.title);
            } catch (error) {
                status.textContent = `‚ùå Fehler bei der Freigabe: ${error.message}`;
                status.className = 'status error';
                console.error('Approve error:', error);
            }
        }

        function loadApprovedTrack() {
            const status = document.getElementById('approved-status');
            const trackDiv = document.getElementById('approved-track');
            
            try {
                const stored = localStorage.getItem('aural_tracks');
                const tracks = stored ? JSON.parse(stored) : [];
                
                if (tracks.length === 0) {
                    status.textContent = '‚ùå Keine freigegebenen Tracks gefunden';
                    status.className = 'status error';
                    return;
                }

                const track = tracks[tracks.length - 1]; // Neuester Track
                approvedTrack = track;

                status.textContent = `‚úÖ Track geladen: ${track.title}`;
                status.className = 'status success';
                
                trackDiv.innerHTML = `
                    <div class="track-item">
                        <div class="track-info">
                            <h4>${track.title}</h4>
                            <p><strong>Datei:</strong> ${track.filename}</p>
                            <p><strong>Gr√∂√üe:</strong> ${(track.fileSize / 1024).toFixed(1)} KB</p>
                            <p><strong>URL Typ:</strong> ${track.url.startsWith('data:') ? 'Base64' : 'Blob'}</p>
                        </div>
                        <div class="track-actions">
                            <button class="play-btn" onclick="playApprovedAudio()">‚ñ∂Ô∏è Abspielen</button>
                            <button class="test-btn" onclick="testApprovedAudio()">üß™ Audio Testen</button>
                        </div>
                        <div class="audio-test">
                            <h5>Audio Player:</h5>
                            <audio controls>
                                <source src="${track.url}" type="${track.format}">
                            </audio>
                        </div>
                    </div>
                `;

                console.log('Approved track loaded:', track.title);
            } catch (error) {
                status.textContent = `‚ùå Fehler: ${error.message}`;
                status.className = 'status error';
                console.error('Load error:', error);
            }
        }

        function playApprovedAudio() {
            if (approvedTrack && approvedTrack.url) {
                const audio = new Audio(approvedTrack.url);
                audio.play().catch(error => {
                    console.error('Audio play failed:', error);
                });
            }
        }

        function testApprovedAudio() {
            if (!approvedTrack) {
                console.error('No approved track loaded');
                return;
            }

            console.log('üß™ Testing approved audio...');
            console.log('Track URL type:', approvedTrack.url.startsWith('data:') ? 'Base64' : 'Blob');
            console.log('Track URL length:', approvedTrack.url.length);
            console.log('Track format:', approvedTrack.format);
            console.log('Track file size:', approvedTrack.fileSize);

            // Test Audio Element
            const audio = new Audio(approvedTrack.url);
            
            audio.addEventListener('loadstart', () => {
                console.log('‚úÖ Audio load started');
            });
            
            audio.addEventListener('loadeddata', () => {
                console.log('‚úÖ Audio data loaded');
            });
            
            audio.addEventListener('canplay', () => {
                console.log('‚úÖ Audio can play');
            });
            
            audio.addEventListener('error', (e) => {
                console.error('‚ùå Audio error:', e);
            });
            
            audio.addEventListener('play', () => {
                console.log('‚úÖ Audio started playing');
            });
            
            audio.addEventListener('pause', () => {
                console.log('‚è∏Ô∏è Audio paused');
            });
            
            audio.addEventListener('ended', () => {
                console.log('üèÅ Audio ended');
            });

            // Try to play
            audio.play().then(() => {
                console.log('‚úÖ Audio play successful');
            }).catch(error => {
                console.error('‚ùå Audio play failed:', error);
            });
        }
    </script>
</body>
</html>
