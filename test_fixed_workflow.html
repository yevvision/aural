<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Korrigierter Workflow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        pre { background: #2d2d2d; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .track { margin: 10px 0; padding: 10px; background: #333; border-radius: 4px; }
        .step { margin: 10px 0; padding: 10px; background: #444; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>🔧 Test: Korrigierter Workflow</h1>
    
    <div class="section">
        <h2>🔍 Problem identifiziert und behoben</h2>
        <div class="info">
            <p><strong>Problem:</strong> localStorage Schlüssel Mismatch</p>
            <ul>
                <li>Zentrale DB speichert unter: <code>aural-central-database</code></li>
                <li>useDatabase suchte nach: <code>aural_tracks</code></li>
                <li>Resultat: Freigegebene Tracks wurden nicht geladen</li>
            </ul>
            <p><strong>Lösung:</strong> useDatabase Hook korrigiert um richtige localStorage Struktur zu verwenden</p>
        </div>
    </div>
    
    <div class="section">
        <h2>🧪 Test: Korrigierter Workflow</h2>
        <button class="button" onclick="testCorrectedWorkflow()">🔄 Korrigierten Workflow testen</button>
        <div id="workflowResult"></div>
    </div>
    
    <div class="section">
        <h2>📊 Aktueller Zustand</h2>
        <button class="button" onclick="showCurrentState()">🔍 Zustand anzeigen</button>
        <div id="currentState"></div>
    </div>

    <script>
        // Simuliere die korrigierten Services
        const DatabaseService = {
            tracks: [],
            addTrack: function(track) {
                this.tracks.push(track);
                console.log(`✅ Track zur DB hinzugefügt: ${track.title} (ID: ${track.id})`);
                
                // Simuliere zentrale DB Speicherung
                const centralDBData = JSON.parse(localStorage.getItem('aural-central-database') || '{}');
                if (!Array.isArray(centralDBData.tracks)) {
                    centralDBData.tracks = [];
                }
                centralDBData.tracks.push(track);
                localStorage.setItem('aural-central-database', JSON.stringify(centralDBData));
                
                return true;
            },
            getTracks: function() {
                console.log(`📚 DB getTracks() - Anzahl: ${this.tracks.length}`);
                return [...this.tracks];
            }
        };

        async function testCorrectedWorkflow() {
            console.log('🧪 Teste korrigierten Workflow...');
            
            // 1. Upload simulieren
            console.log('📤 Schritt 1: Upload simulieren');
            const uploadId = 'test_upload_' + Date.now();
            const audioBlob = new Blob(['fake audio data'], { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            const pendingUpload = {
                uploadId: uploadId,
                filename: 'test_audio.mp3',
                originalName: 'Test Audio Recording.mp3',
                size: 1024000,
                mimeType: 'audio/mpeg',
                url: audioUrl,
                title: 'Test Audio ' + new Date().toLocaleTimeString(),
                description: 'Test-Beschreibung',
                gender: 'couples',
                tags: ['test', 'debug'],
                uploadedAt: new Date().toISOString(),
                status: 'pending_review',
                reason: 'Test-Upload',
                duplicateCount: 0,
                deviceId: 'device_123',
                userId: 'user-1',
                username: 'TestUser',
                duration: 30
            };
            
            // Speichere in Pending-Queue
            const pendingData = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
            pendingData[uploadId] = pendingUpload;
            localStorage.setItem('aural_pending_uploads', JSON.stringify(pendingData));
            console.log(`✅ Upload simuliert: ${pendingUpload.title}`);
            
            // 2. Admin Approval simulieren
            console.log('✅ Schritt 2: Admin Approval simulieren');
            
            // Konvertiere Blob-URL zu Base64
            let audioDataUrl = pendingUpload.url;
            if (pendingUpload.url && pendingUpload.url.startsWith('blob:')) {
                try {
                    const response = await fetch(pendingUpload.url);
                    const blob = await response.blob();
                    audioDataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                    console.log('✅ Audio-Daten zu Base64 konvertiert');
                } catch (error) {
                    console.error('❌ Fehler beim Konvertieren:', error);
                }
            }
            
            // Erstelle approved Track
            const approvedTrack = {
                id: pendingUpload.uploadId,
                title: pendingUpload.title,
                description: pendingUpload.description,
                url: audioDataUrl,
                duration: pendingUpload.duration || 0,
                user: {
                    id: pendingUpload.userId,
                    username: pendingUpload.username,
                    email: '',
                    avatar: '',
                    createdAt: new Date(),
                    isAdmin: false
                },
                likes: 0,
                isLiked: false,
                isBookmarked: false,
                createdAt: new Date(), // WICHTIG: Aktuelles Datum
                tags: pendingUpload.tags,
                gender: pendingUpload.gender,
                filename: pendingUpload.filename,
                fileSize: pendingUpload.size,
                format: pendingUpload.mimeType
            };
            
            // Speichere in DatabaseService (simuliert zentrale DB)
            DatabaseService.addTrack(approvedTrack);
            
            // Entferne aus Pending-Liste
            delete pendingData[uploadId];
            localStorage.setItem('aural_pending_uploads', JSON.stringify(pendingData));
            
            console.log(`✅ Upload approved: ${approvedTrack.title}`);
            
            // 3. FeedPage Simulation (korrigiert)
            console.log('🏠 Schritt 3: FeedPage Simulation (korrigiert)');
            
            // Lade Daten wie useDatabase (korrigiert)
            const dbTracks = DatabaseService.getTracks();
            const centralDBData = JSON.parse(localStorage.getItem('aural-central-database') || '{}');
            const localTracks = Array.isArray(centralDBData.tracks) ? centralDBData.tracks : [];
            
            console.log(`📊 DB Tracks: ${dbTracks.length}, Central DB Tracks: ${localTracks.length}`);
            
            // Kombiniere und dedupliziere Tracks
            const allTracksMap = new Map();
            dbTracks.forEach(track => allTracksMap.set(track.id, track));
            localTracks.forEach(track => allTracksMap.set(track.id, track));
            const allTracks = Array.from(allTracksMap.values());
            
            console.log(`🏠 FeedPage - Alle Tracks: ${allTracks.length}`);
            
            // Simuliere "New" Kategorie Filter
            const now = new Date();
            const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
            
            const newTracks = allTracks
                .filter(track => new Date(track.createdAt) > twoWeeksAgo)
                .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
            
            console.log(`🆕 New Kategorie - Gefilterte Tracks: ${newTracks.length}`);
            console.log(`📅 Two weeks ago: ${twoWeeksAgo.toISOString()}`);
            
            let html = `
                <div class="step">
                    <h3>🧪 Korrigierter Workflow-Test Ergebnis:</h3>
                    <p><strong>DB Tracks:</strong> ${dbTracks.length}</p>
                    <p><strong>Central DB Tracks:</strong> ${localTracks.length}</p>
                    <p><strong>Alle Tracks (dedupliziert):</strong> ${allTracks.length}</p>
                    <p><strong>New Kategorie (2 Wochen):</strong> ${newTracks.length}</p>
                    <p><strong>Two weeks ago:</strong> ${twoWeeksAgo.toISOString()}</p>
                </div>
            `;
            
            if (newTracks.length > 0) {
                html += '<div class="step"><h4>✅ New Kategorie Tracks (sollten angezeigt werden):</h4>';
                newTracks.forEach(track => {
                    const isRecent = new Date(track.createdAt) > twoWeeksAgo;
                    html += `<div class="track">
                        <strong>${track.title}</strong> (ID: ${track.id})<br>
                        CreatedAt: ${track.createdAt.toISOString()}<br>
                        Is Recent: ${isRecent ? '✅' : '❌'}<br>
                        URL: ${track.url ? (track.url.startsWith('data:') ? 'Base64' : 'Blob') : 'No URL'}
                    </div>`;
                });
                html += '</div>';
            } else {
                html += '<div class="warning">⚠️ Keine Tracks in der "New" Kategorie gefunden!</div>';
            }
            
            document.getElementById('workflowResult').innerHTML = html;
            
            console.log('✅ Korrigierter Workflow-Test abgeschlossen');
        }

        function showCurrentState() {
            const dbTracks = DatabaseService.getTracks();
            const centralDBData = JSON.parse(localStorage.getItem('aural-central-database') || '{}');
            const localTracks = Array.isArray(centralDBData.tracks) ? centralDBData.tracks : [];
            const pendingUploads = JSON.parse(localStorage.getItem('aural_pending_uploads') || '{}');
            
            let html = `
                <div class="step">
                    <h3>📊 Aktueller Zustand:</h3>
                    <p><strong>DatabaseService Tracks:</strong> ${dbTracks.length}</p>
                    <p><strong>Central DB Tracks (aural-central-database):</strong> ${localTracks.length}</p>
                    <p><strong>Pending Uploads:</strong> ${Object.keys(pendingUploads).length}</p>
                </div>
            `;
            
            if (dbTracks.length > 0) {
                html += '<div class="step"><h4>DatabaseService Tracks:</h4>';
                dbTracks.forEach(track => {
                    const isRecent = new Date(track.createdAt) > new Date(Date.now() - 14 * 24 * 60 * 60 * 1000);
                    html += `<div class="track">
                        <strong>${track.title}</strong> (ID: ${track.id})<br>
                        CreatedAt: ${track.createdAt.toISOString()}<br>
                        Is Recent (2 weeks): ${isRecent ? '✅' : '❌'}<br>
                        URL: ${track.url ? (track.url.startsWith('data:') ? 'Base64' : 'Blob') : 'No URL'}
                    </div>`;
                });
                html += '</div>';
            }
            
            if (localTracks.length > 0) {
                html += '<div class="step"><h4>Central DB Tracks:</h4>';
                localTracks.forEach(track => {
                    const isRecent = new Date(track.createdAt) > new Date(Date.now() - 14 * 24 * 60 * 60 * 1000);
                    html += `<div class="track">
                        <strong>${track.title}</strong> (ID: ${track.id})<br>
                        CreatedAt: ${track.createdAt.toISOString()}<br>
                        Is Recent (2 weeks): ${isRecent ? '✅' : '❌'}<br>
                        URL: ${track.url ? (track.url.startsWith('data:') ? 'Base64' : 'Blob') : 'No URL'}
                    </div>`;
                });
                html += '</div>';
            }
            
            document.getElementById('currentState').innerHTML = html;
        }

        // Initialisierung
        console.log('🚀 Korrigierter Workflow-Test initialisiert');
    </script>
</body>
</html>
